<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Study Build - å­¦ç¿’ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #676f78 0%, #6f7a84 100%);
            color: #212529;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.8rem;
            color: #ffffff;
            margin-bottom: 10px;
            font-weight: bold;
        }

        .header p {
            color: #6c757d;
            font-size: 1.1rem;
        }

        .nav-tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .tab-btn {
            padding: 12px 24px;
            background: white;
            border: 2px solid #808080;
            border-radius: 8px;
            color: #808080;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .tab-btn:hover,
        .tab-btn.active {
            background: #808080;
            color: white;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(13, 110, 253, 0.3);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            border: 1px solid #dee2e6;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .card h2, .card h3 {
            color: #212529;
            margin-bottom: 20px;
            border-bottom: 2px solid #808080;
            padding-bottom: 10px;
        }

        /* ã‚¿ã‚¤ãƒãƒ¼ - æ”¹å–„ã•ã‚ŒãŸãƒ‡ã‚¶ã‚¤ãƒ³ */
        .timer-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 40px 20px;
            background: linear-gradient(135deg, #464545b0 0%, #464646b0 100%);
            border-radius: 20px;
            color: white;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
            position: relative;
            overflow: hidden;
        }

        .timer-container::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255,255,255,0.1), transparent);
            transform: rotate(45deg);
            animation: shimmer 3s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
            100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
        }

        .timer-circle {
            position: relative;
            width: 280px;
            height: 280px;
            margin: 20px 0;
        }

        .timer-progress {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: conic-gradient(#ffffff 0deg, #e0dddc 360deg);
            padding: 8px;
            box-shadow: 0 0 20px rgba(79, 172, 254, 0.5);
        }

        .timer-progress-inner {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: linear-gradient(135deg, #858585 0%, #242424 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .timer-display {
            font-size: 3.2rem;
            font-weight: bold;
            color: white;
            font-family: 'Courier New', monospace;
            text-shadow: 0 2px 10px rgba(239, 238, 238, 0.3);
            letter-spacing: 2px;
            z-index: 2;
        }

        .timer-label {
            position: absolute;
            bottom: 60px;
            font-size: 1rem;
            color: rgba(255,255,255,0.8);
            font-weight: 500;
        }

        .timer-controls {
            display: flex;
            gap: 15px;
            margin-top: 30px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .timer-btn {
            padding: 15px 30px;
            border: none;
            border-radius: 50px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            min-width: 120px;
            box-shadow: 0 4px 15px rgba(115, 115, 115, 0.2);
        }

        .timer-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .timer-btn:hover::before {
            left: 100%;
        }

        .timer-btn-start {
            background: linear-gradient(135deg, #3c3c3c 0%, #3c3c3c 100%);
            color: rgb(255, 255, 255);
        }

        .timer-btn-start:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(79, 172, 254, 0.4);
        }

        .timer-btn-pause {
            background: linear-gradient(135deg, #3d3d3d 0%, #3c3c3c 100%);
            color: #ffffff;
        }

        .timer-btn-pause:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(252, 182, 159, 0.4);
        }

        .timer-btn-stop {
            background: linear-gradient(135deg, #3c3c3c 0%, #3c3c3c 100%);
            color: #ffffff;
        }

        .timer-btn-stop:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(168, 237, 234, 0.4);
        }

        .timer-btn:active {
            transform: translateY(0);
        }

        .timer-btn.running {
            background: linear-gradient(135deg, lab(74.42% 0 -0.01) 0%, lab(25.76% 0 0) 100%);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .subject-selector {
            background: rgba(255,255,255,0.1);
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            backdrop-filter: blur(10px);
            width: 100%;
            max-width: 400px;
        }

        .subject-selector label {
            display: block;
            color: rgba(255,255,255,0.9);
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 12px;
            text-align: center;
        }

        .subject-selector select {
            width: 100%;
            padding: 15px 20px;
            background: rgba(255,255,255,0.9);
            border: none;
            border-radius: 10px;
            font-size: 16px;
            color: #333;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .subject-selector select:focus {
            outline: none;
            background: white;
            box-shadow: 0 4px 20px rgba(79, 172, 254, 0.3);
            transform: translateY(-1px);
        }

        .timer-stats {
            display: flex;
            justify-content: space-around;
            width: 100%;
            max-width: 500px;
            margin-top: 30px;
            gap: 20px;
        }

        .timer-stat {
            text-align: center;
            background: rgba(255,255,255,0.1);
            padding: 15px 20px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
            flex: 1;
        }

        .timer-stat-number {
            font-size: 1.8rem;
            font-weight: bold;
            color: #ffffff;
            display: block;
            margin-bottom: 5px;
        }

        .timer-stat-label {
            font-size: 0.9rem;
            color: #ffffff;
        }

        /* Barcode scanner modal */
        .scanner-modal {
            position: fixed;
            inset: 0;
            display: none;
            align-items: center;
            justify-content: center;
            background: rgba(0,0,0,0.6);
            z-index: 9999;
        }

        .scanner-modal.active { display: flex; }

        .scanner-box {
            background: white;
            width: 90%;
            max-width: 700px;
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.4);
        }

        .scanner-video {
            width: 100%;
            height: 360px;
            background: black;
            border-radius: 8px;
            overflow: hidden;
            position: relative;
        }

        .scanner-controls { display:flex; gap:8px; margin-top:8px; justify-content:flex-end; }


        /* ãƒ•ã‚©ãƒ¼ãƒ  */
        .input-group {
            margin-bottom: 15px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            color: #212529;
            font-weight: 500;
        }

        .input-group input,
        .input-group select,
        .input-group textarea {
            width: 100%;
            padding: 12px;
            background: white;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            color: #212529;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .input-group input:focus,
        .input-group select:focus,
        .input-group textarea:focus {
            outline: none;
            border-color: #0d6efd;
            box-shadow: 0 0 0 3px rgba(13, 110, 253, 0.1);
        }

        /* Todo + ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼çµ±åˆãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
        .todo-calendar-container {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 20px;
            height: 600px;
        }

        .todo-panel {
            background: white;
            border-radius: 12px;
            padding: 20px;
            border: 1px solid #dee2e6;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            overflow-y: auto;
        }

        .calendar-panel {
            background: white;
            border-radius: 12px;
            padding: 20px;
            border: 1px solid #dee2e6;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .calendar-nav {
            background: #404040;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
        }

        .calendar-nav:hover {
            background: #0b5ed7;
        }

        .view-toggle {
            display: flex;
            gap: 5px;
        }

        .view-btn {
            padding: 6px 12px;
            background: white;
            border: 2px solid #0d6efd;
            color: #0d6efd;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
        }

        .view-btn:first-child {
            border-radius: 6px 0 0 6px;
        }

        .view-btn:last-child {
            border-radius: 0 6px 6px 0;
        }

        .view-btn.active {
            background: #0d6efd;
            color: white;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background: #dee2e6;
            border-radius: 8px;
            overflow: hidden;
        }

        .calendar-day {
            background: white;
            padding: 8px;
            min-height: 80px;
            position: relative;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .calendar-day:hover {
            background: #f8f9fa;
        }

        .calendar-day.other-month {
            color: #6c757d;
            background: #f8f9fa;
        }

        .calendar-day.today {
            background: #e7f3ff;
            border-color: #0d6efd;
        }

        .calendar-day.selected {
            background: #0d6efd;
            color: white;
        }

        .calendar-day-number {
            font-weight: bold;
            margin-bottom: 4px;
        }

        .calendar-todo {
            font-size: 10px;
            background: #0d6efd;
            color: white;
            padding: 2px 4px;
            border-radius: 3px;
            margin-bottom: 2px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            cursor: pointer;
        }

        .calendar-todo.completed {
            background: #198754;
            text-decoration: line-through;
        }

        .calendar-todo.overdue {
            background: #dc3545;
        }

        /* Todoé …ç›® */
        .todo-item {
            display: flex;
            align-items: center;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 8px;
            border-left: 4px solid #0d6efd;
            transition: all 0.3s ease;
        }

        .todo-item:hover {
            background: #e9ecef;
            transform: translateX(3px);
        }

        .todo-item.completed {
            opacity: 0.7;
            border-left-color: #198754;
        }

        .todo-item.overdue {
            border-left-color: #dc3545;
            background: #f8d7da;
        }

        .todo-checkbox {
            margin-right: 12px;
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .todo-content {
            flex: 1;
        }

        .todo-text {
            font-weight: 500;
            margin-bottom: 4px;
        }

        .todo-text.completed {
            text-decoration: line-through;
        }

        .todo-meta {
            font-size: 12px;
            color: #6c757d;
        }

        .todo-actions {
            display: flex;
            gap: 5px;
        }

        .selected-date-header {
            color: #0d6efd;
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #0d6efd;
        }

        .quick-add {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
        }

        .quick-add input {
            flex: 1;
            padding: 8px;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            font-size: 14px;
        }

        .quick-add button {
            padding: 8px 16px;
            background: #0d6efd;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }

        /* çµ±è¨ˆ */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-card {
            text-align: center;
            padding: 20px;
            background: white;
            border-radius: 12px;
            border: 2px solid #0d6efd;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .stat-number {
            font-size: 2.2rem;
            font-weight: bold;
            color: #0d6efd;
            display: block;
        }

        .stat-label {
            color: #6c757d;
            margin-top: 5px;
        }

        .chart-container {
            position: relative;
            height: 300px;
            margin: 20px 0;
        }

        /* ãƒãƒƒã‚¸ */
        .badge-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 15px;
        }

        .badge {
            text-align: center;
            padding: 15px;
            background: white;
            border-radius: 12px;
            border: 2px solid #dee2e6;
            transition: all 0.3s ease;
        }

        .badge.earned {
            border-color: #ffc107;
            background: linear-gradient(135deg, #fff3cd, #ffeaa7);
            box-shadow: 0 4px 15px rgba(255, 193, 7, 0.3);
        }

        .badge-icon {
            font-size: 1.5rem;
            margin-bottom: 8px;
            display: block;
        }

        .badge-name {
            font-weight: bold;
            color: #212529;
            margin-bottom: 5px;
            font-size: 12px;
        }

        /* ãƒ©ãƒ³ã‚­ãƒ³ã‚° */
        .ranking-tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 15px;
        }

        .ranking-tab-btn {
            padding: 6px 12px;
            background: white;
            border: 2px solid #0d6efd;
            color: #0d6efd;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
            border-radius: 6px;
        }

        .ranking-tab-btn.active {
            background: #0d6efd;
            color: white;
        }

        .ranking-item {
            display: flex;
            align-items: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 8px;
            transition: all 0.3s ease;
            position: relative;
        }

        .ranking-item.own {
            background: linear-gradient(135deg, #e7f3ff, #cce7ff);
            border: 2px solid #0d6efd;
            font-weight: bold;
        }

        .ranking-item:hover {
            background: #e9ecef;
            transform: translateX(3px);
        }

        .ranking-item.own:hover {
            background: linear-gradient(135deg, #cce7ff, #b3d9ff);
        }

        .rank-badge {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #6c757d;
            color: white;
            font-weight: bold;
            margin-right: 15px;
            font-size: 16px;
        }

        .rank-badge.gold {
            background: linear-gradient(135deg, #ffd700, #ffed4e);
            color: #212529;
            box-shadow: 0 4px 15px rgba(255, 215, 0, 0.4);
        }

        .rank-badge.silver {
            background: linear-gradient(135deg, #c0c0c0, #e8e8e8);
            color: #212529;
            box-shadow: 0 4px 15px rgba(192, 192, 192, 0.4);
        }

        .rank-badge.bronze {
            background: linear-gradient(135deg, #cd7f32, #daa520);
            color: white;
            box-shadow: 0 4px 15px rgba(205, 127, 50, 0.4);
        }

        .friend-info {
            flex: 1;
            display: flex;
            align-items: center;
        }

        .friend-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: #0d6efd;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            margin-right: 15px;
        }

        .friend-details {
            flex: 1;
        }

        .friend-name {
            font-size: 16px;
            font-weight: 500;
            margin-bottom: 4px;
        }

        .friend-stats {
            font-size: 12px;
            color: #6c757d;
        }

        .friend-badges {
            display: flex;
            gap: 3px;
            margin-top: 5px;
        }

        .mini-badge {
            font-size: 14px;
            opacity: 0.7;
        }

        .mini-badge.earned {
            opacity: 1;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .ranking-score {
            font-size: 18px;
            font-weight: bold;
            color: #0d6efd;
        }

        .crown-icon {
            position: absolute;
            top: -5px;
            right: -5px;
            font-size: 20px;
            animation: bounce 2s infinite;
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-10px); }
            60% { transform: translateY(-5px); }
        }

        /* ãƒãƒƒã‚¸é€²æ— */
        .badge-progress-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }

        .badge-progress-item {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 15px;
            border: 2px solid #dee2e6;
            transition: all 0.3s ease;
        }

        .badge-progress-item.earned {
            border-color: #ffc107;
            background: linear-gradient(135deg, #fff3cd, #ffeaa7);
            box-shadow: 0 4px 15px rgba(255, 193, 7, 0.3);
        }

        .badge-progress-header {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .badge-progress-icon {
            font-size: 24px;
            margin-right: 10px;
        }

        .badge-progress-info {
            flex: 1;
        }

        .badge-progress-name {
            font-weight: bold;
            color: #212529;
            margin-bottom: 2px;
        }

        .badge-progress-desc {
            font-size: 12px;
            color: #6c757d;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #dee2e6;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 5px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #0d6efd, #0b5ed7);
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        .progress-fill.completed {
            background: linear-gradient(90deg, #198754, #157347);
        }

        .progress-text {
            font-size: 11px;
            color: #6c757d;
            text-align: center;
        }

        /* ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ */
        .timeline-post-form {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 30px;
            border: 2px solid #0d6efd;
        }

        .timeline-post-form h3 {
            color: #0d6efd;
            margin-bottom: 15px;
            border-bottom: none;
            padding-bottom: 0;
        }

        .timeline-container {
            max-height: 600px;
            overflow-y: auto;
            padding-right: 10px;
        }

        .timeline-post {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #dee2e6;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }

        .timeline-post:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
        }

        .timeline-post.own {
            border-left: 4px solid #0d6efd;
            background: linear-gradient(135deg, #f8f9ff, #e7f3ff);
        }

        .post-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }

        .post-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: #0d6efd;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            margin-right: 15px;
        }

        .post-info {
            flex: 1;
        }

        .post-author {
            font-weight: bold;
            color: #212529;
            margin-bottom: 2px;
        }

        .post-time {
            font-size: 12px;
            color: #6c757d;
        }

        .post-type {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
            margin-left: 10px;
        }

        .post-type.study {
            background: #e7f3ff;
            color: #0d6efd;
        }

        .post-type.achievement {
            background: #fff3cd;
            color: #856404;
        }

        .post-type.motivation {
            background: #d1ecf1;
            color: #0c5460;
        }

        .post-type.question {
            background: #f8d7da;
            color: #721c24;
        }

        .post-content {
            font-size: 16px;
            line-height: 1.5;
            color: #212529;
            margin-bottom: 15px;
        }

        .post-stats {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 14px;
            color: #6c757d;
        }

        .post-actions {
            display: flex;
            gap: 15px;
            padding-top: 15px;
            border-top: 1px solid #dee2e6;
        }

        .post-action-btn {
            background: none;
            border: none;
            color: #6c757d;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 8px 12px;
            border-radius: 20px;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .post-action-btn:hover {
            background: #f8f9fa;
            color: #0d6efd;
        }

        .post-action-btn.liked {
            color: #dc3545;
            background: #f8d7da;
        }

        .post-action-btn.commented {
            color: #0d6efd;
            background: #e7f3ff;
        }

        .comments-section {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #dee2e6;
            display: none;
        }

        .comments-section.show {
            display: block;
        }

        .comment-form {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .comment-input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #dee2e6;
            border-radius: 20px;
            font-size: 14px;
        }

        .comment-btn {
            padding: 8px 16px;
            background: #0d6efd;
            color: white;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
        }

        .comment {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .comment-avatar {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: #6c757d;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            flex-shrink: 0;
        }

        .comment-content {
            flex: 1;
        }

        .comment-author {
            font-weight: bold;
            font-size: 13px;
            color: #212529;
            margin-bottom: 2px;
        }

        .comment-text {
            font-size: 14px;
            color: #495057;
            line-height: 1.4;
        }

        .comment-time {
            font-size: 11px;
            color: #6c757d;
            margin-top: 2px;
        }

        .no-posts {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }

        .no-posts-icon {
            font-size: 3rem;
            margin-bottom: 15px;
        }

        /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ */
        @media (max-width: 768px) {
            .todo-calendar-container {
                grid-template-columns: 1fr;
                height: auto;
            }
            
            .calendar-day {
                min-height: 60px;
                padding: 4px;
            }
            
            .calendar-todo {
                font-size: 9px;
            }
            
            .header h1 {
                font-size: 2.2rem;
            }
            
            .timer-display {
                font-size: 2.5rem;
            }

            .timer-circle {
                width: 220px;
                height: 220px;
            }
            
            .timer-display {
                font-size: 2.5rem;
            }
            
            .timer-controls {
                gap: 10px;
            }
            
            .timer-btn {
                padding: 12px 24px;
                min-width: 100px;
                font-size: 14px;
            }
            
            .timer-stats {
                flex-direction: column;
                gap: 15px;
            }
        }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 15% auto;
            padding: 20px;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.3);
        }

        .close {
            color: #6c757d;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: #212529;
        }

/* ç§‘ç›®è¿½åŠ æ–¹æ³•ã‚¿ãƒ– */
.subject-add-methods {
    margin-bottom: 30px;
}

.add-method-tabs {
    display: flex;
    gap: 5px;
    margin-bottom: 20px;
}

.method-tab-btn {
    padding: 10px 20px;
    background: white;
    border: 2px solid #0d6efd;
    color: #0d6efd;
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
    transition: all 0.3s ease;
    border-radius: 8px;
}

.method-tab-btn.active,
.method-tab-btn:hover {
    background: #0d6efd;
    color: white;
}

.add-method-content {
    display: none;
}

.add-method-content.active {
    display: block;
}

/* ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚¹ã‚­ãƒ£ãƒŠãƒ¼ */
/* DELETED */

/* æ›¸ç±çµæœè¡¨ç¤º */
/* DELETED */

/* å¸Œå°‘åº¦åˆ¥ã®ãƒãƒƒã‚¸ã‚¹ã‚¿ã‚¤ãƒ« */
.badge-rarity {
    position: absolute;
    top: -5px;
    right: -5px;
    padding: 2px 6px;
    border-radius: 10px;
    font-size: 10px;
    font-weight: bold;
    text-transform: uppercase;
}

.rarity-common {
    background: linear-gradient(135deg, #6c757d, #adb5bd);
    color: white;
}

.rarity-uncommon {
    background: linear-gradient(135deg, #28a745, #20c997);
    color: white;
}

.rarity-rare {
    background: linear-gradient(135deg, #007bff, #6610f2);
    color: white;
}

.rarity-epic {
    background: linear-gradient(135deg, #6f42c1, #e83e8c);
    color: white;
}

.rarity-legendary {
    background: linear-gradient(135deg, #fd7e14, #ffc107);
    color: #212529;
    animation: legendaryGlow 2s ease-in-out infinite alternate;
}

.rarity-mythical {
    background: linear-gradient(135deg, #dc3545, #fd7e14);
    color: white;
    animation: mythicalPulse 1.5s ease-in-out infinite;
}

.rarity-transcendent {
    background: linear-gradient(135deg, #6f42c1, #007bff, #28a745, #ffc107);
    background-size: 400% 400%;
    color: white;
    animation: transcendentRainbow 3s ease infinite;
}

@keyframes legendaryGlow {
    from { box-shadow: 0 0 5px rgba(255, 193, 7, 0.5); }
    to { box-shadow: 0 0 20px rgba(255, 193, 7, 0.8); }
}

@keyframes mythicalPulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.1); }
}

@keyframes transcendentRainbow {
    0% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
    100% { background-position: 0% 50%; }
}

/* é”æˆç‡è¡¨ç¤º */
.achievement-rate {
    font-size: 11px;
    color: #6c757d;
    margin-top: 3px;
    font-weight: normal;
}

.achievement-rate.ultra-rare {
    color: #dc3545;
    font-weight: bold;
}

.achievement-rate.super-rare {
    color: #fd7e14;
    font-weight: bold;
}

.achievement-rate.rare {
    color: #ffc107;
    font-weight: bold;
}

/* ãƒãƒƒã‚¸é€²æ—ã§ã®é”æˆç‡è¡¨ç¤º */
.badge-progress-stats {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 8px;
    padding-top: 8px;
    border-top: 1px solid #dee2e6;
}

.global-stats {
    font-size: 10px;
    color: #6c757d;
}

.rarity-indicator {
    padding: 2px 6px;
    border-radius: 8px;
    font-size: 9px;
    font-weight: bold;
    text-transform: uppercase;
}
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Study Build</h1>
            <p>å­¦ç¿’ã‚’ç®¡ç†</p>
        </div>

        <div class="nav-tabs">
            <button class="tab-btn active" onclick="showTab('planner')">ãƒ—ãƒ©ãƒ³</button>
            <button class="tab-btn" onclick="showTab('timer')">ã‚¿ã‚¤ãƒãƒ¼</button>
            <button class="tab-btn" onclick="showTab('subjects')">ç§‘ç›®ç®¡ç†</button>
            <button class="tab-btn" onclick="showTab('stats')">çµ±è¨ˆ</button>
            <button class="tab-btn" onclick="showTab('badges')">ãƒãƒƒã‚¸</button>
            <button class="tab-btn" onclick="showTab('timeline')">ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³</button>
        </div>

        <!-- ãƒ—ãƒ©ãƒ³ãƒŠãƒ¼ã‚¿ãƒ–ï¼ˆTodo + ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼çµ±åˆï¼‰ -->
        <div id="planner" class="tab-content active">
            <div class="todo-calendar-container">
                <!-- Todo ãƒ‘ãƒãƒ« -->
                <div class="todo-panel">
                    <div class="selected-date-header" id="selectedDateHeader">
                        ä»Šæ—¥ã®ã‚¿ã‚¹ã‚¯
                    </div>
                    
                    <div class="quick-add">
                        <input type="text" id="quickTodoInput" placeholder="æ–°ã—ã„ã‚¿ã‚¹ã‚¯ã‚’è¿½åŠ ...">
                        <button onclick="addQuickTodo()">è¿½åŠ </button>
                    </div>
                    
                    <div id="todoList"></div>
                    
                    <button class="btn" onclick="openTodoModal()" style="width: 100%; margin-top: 15px;">
                        è©³ç´°ãªã‚¿ã‚¹ã‚¯ã‚’è¿½åŠ 
                    </button>
                </div>

                <!-- ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ ãƒ‘ãƒãƒ« -->
                <div class="calendar-panel">
                    <div class="calendar-header">
                        <button class="calendar-nav" onclick="changeMonth(-1)">â€¹</button>
                        <h3 id="currentMonth"></h3>
                        <button class="calendar-nav" onclick="changeMonth(1)">â€º</button>
                        
                        <div class="view-toggle">
                            <button class="view-btn active" onclick="setCalendarView('month')">æœˆ</button>
                            <button class="view-btn" onclick="setCalendarView('week')">é€±</button>
                        </div>
                    </div>
                    
                    <div class="calendar-grid" id="calendarGrid"></div>
                </div>
            </div>
        </div>

        <!-- ã‚¿ã‚¤ãƒãƒ¼ã‚¿ãƒ– -->
        <div id="timer" class="tab-content">
    <div class="card" style="background: transparent; border: none; box-shadow: none; padding: 0;">
        <div class="timer-container">
            <h2 style="color: white; text-align: center; margin-bottom: 20px; font-size: 2rem; text-shadow: 0 2px 10px rgba(0,0,0,0.3);">
                å‹‰å¼·ã‚¿ã‚¤ãƒãƒ¼-
            </h2>
            
            <div class="subject-selector">
                <label for="subjectSelect"> ç§‘ç›®ã‚’é¸æŠ</label>
                <select id="subjectSelect">
                    <option value="">ç§‘ç›®ã‚’é¸æŠã—ã¦ãã ã•ã„</option>
                </select>
            </div>

            <div class="timer-circle">
                <div class="timer-progress">
                    <div class="timer-progress-inner">
                        <div class="timer-display" id="timerDisplay">00:00:00</div>
                        <div class="timer-label">å‹‰å¼·æ™‚é–“</div>
                    </div>
                </div>
            </div>

            <div class="timer-controls">
                <button class="timer-btn timer-btn-start" id="startBtn" onclick="startTimer()">
                    â–¶ï¸ é–‹å§‹
                </button>
                <button class="timer-btn timer-btn-pause" onclick="pauseTimer()">
                    â¸ï¸ ä¸€æ™‚åœæ­¢
                </button>
            </div>

            <!-- Barcode scanner modal -->
            <div id="scannerModal" class="scanner-modal" aria-hidden="true">
                <div class="scanner-box">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                        <strong>ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚¹ã‚­ãƒ£ãƒŠ</strong>
                        <div>
                            <button class="btn btn-small" onclick="closeScanner()">é–‰ã˜ã‚‹</button>
                        </div>
                    </div>
                    <div id="scannerVideo" class="scanner-video"></div>
                    <div id="scannerResult" style="margin-top:8px;color:#212529;"></div>
                    <div class="scanner-controls">
                        <button class="btn btn-small" onclick="startScanner()">ã‚¹ã‚­ãƒ£ãƒ³é–‹å§‹</button>
                        <button class="btn btn-small" onclick="stopScanner()">åœæ­¢</button>
                        <button class="btn btn-small" onclick="manualIsbn()">æ‰‹å…¥åŠ›ã§è¿½åŠ </button>
                    </div>
                </div>
            </div>
                <button class="timer-btn timer-btn-stop" onclick="stopTimer()">
                    â¹ï¸ å®Œäº†
                </button>
            </div>

            <div class="timer-stats">
                <div class="timer-stat">
                    <span class="timer-stat-number" id="todayStudyTime">0</span>
                    <div class="timer-stat-label">ä»Šæ—¥ã®å‹‰å¼·æ™‚é–“(åˆ†)</div>
                </div>
                <div class="timer-stat">
                    <span class="timer-stat-number" id="currentSession">0</span>
                    <div class="timer-stat-label">ç¾åœ¨ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³(åˆ†)</div>
                </div>
            </div>
        </div>
    </div>
</div>

        <!-- ç§‘ç›®ç®¡ç†ã‚¿ãƒ– -->
        <div id="subjects" class="tab-content">
    <div class="card">
        <h2>ğŸ“š ç§‘ç›®ç®¡ç†</h2>
        
        <div class="subject-add-methods">
            <div class="add-method-tabs">
                <button class="method-tab-btn active" onclick="showAddMethod('manual')">âœï¸ æ‰‹å‹•å…¥åŠ›</button>
                <!-- DELETED: ãƒãƒ¼ã‚³ãƒ¼ãƒ‰èª­ã¿å–ã‚Šãƒœã‚¿ãƒ³ -->
            </div>
            
            <!-- æ‰‹å‹•å…¥åŠ› -->
            <div id="manual-add" class="add-method-content active">
                <div class="input-group">
                    <input type="text" id="subjectInput" placeholder="æ–°ã—ã„ç§‘ç›®åã‚’å…¥åŠ›...">
                    <button class="btn" onclick="addSubject()">ç§‘ç›®è¿½åŠ </button>
                </div>
            </div>
            
            <!-- ãƒãƒ¼ã‚³ãƒ¼ãƒ‰èª­ã¿å–ã‚Šæ©Ÿèƒ½ã‚’å‰Šé™¤ -->

        </div>

        <div id="subjectList"></div>
    </div>
</div>

        <!-- çµ±è¨ˆã‚¿ãƒ– -->
        <div id="stats" class="tab-content">
            <div class="stats-grid">
                <div class="stat-card">
                    <span class="stat-number" id="totalTime">0</span>
                    <div class="stat-label">ç·å‹‰å¼·æ™‚é–“ (åˆ†)</div>
                </div>
                <div class="stat-card">
                    <span class="stat-number" id="completedTodos">0</span>
                    <div class="stat-label">å®Œäº†ã—ãŸã‚¿ã‚¹ã‚¯</div>
                </div>
                <div class="stat-card">
                    <span class="stat-number" id="totalSubjects">0</span>
                    <div class="stat-label">ç™»éŒ²ç§‘ç›®æ•°</div>
                </div>
                <div class="stat-card">
                    <span class="stat-number" id="weeklyTime">0</span>
                    <div class="stat-label">ä»Šé€±ã®å‹‰å¼·æ™‚é–“ (åˆ†)</div>
                </div>
            </div>

            <!-- ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒ©ãƒ³ã‚­ãƒ³ã‚° -->
            <div class="card">
                <h3>ğŸ† ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒ©ãƒ³ã‚­ãƒ³ã‚°</h3>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <div class="ranking-tabs">
                        <button class="ranking-tab-btn active" onclick="showRanking('time')">å‹‰å¼·æ™‚é–“</button>
                        <button class="ranking-tab-btn" onclick="showRanking('tasks')">å®Œäº†ã‚¿ã‚¹ã‚¯</button>
                        <button class="ranking-tab-btn" onclick="showRanking('badges')">ãƒãƒƒã‚¸æ•°</button>
                    </div>
                    <button class="btn btn-small" onclick="openFriendModal()">ãƒ•ãƒ¬ãƒ³ãƒ‰è¿½åŠ </button>
                </div>
                
                <div id="friendRanking"></div>
            </div>

            <!-- ãƒãƒƒã‚¸ç²å¾—çŠ¶æ³ -->
            <div class="card">
                <h3>ğŸ… ãƒãƒƒã‚¸ç²å¾—çŠ¶æ³</h3>
                <p style="color: #6c757d; margin-bottom: 20px;">å‹‰å¼·æ™‚é–“ã‚„ã‚¿ã‚¹ã‚¯å®Œäº†ã§ãƒãƒƒã‚¸ã‚’ç²å¾—ã—ã‚ˆã†ï¼</p>
                
                <div class="badge-progress-container" id="badgeProgressContainer"></div>
            </div>

            <!-- ç§‘ç›®åˆ¥çµ±è¨ˆ -->
            <div class="card">
                <h3>ğŸ“Š ç§‘ç›®åˆ¥å‹‰å¼·æ™‚é–“</h3>
                <div class="chart-container">
                    <canvas id="studyChart"></canvas>
                </div>
            </div>
        </div>

        <!-- ãƒãƒƒã‚¸ã‚¿ãƒ– -->
        <div id="badges" class="tab-content">
            <div class="card">
                <h2>ğŸ† ç²å¾—ãƒãƒƒã‚¸</h2>
                <p style="color: #6c757d; margin-bottom: 20px;">å­¦ç¿’ã‚’ç¶šã‘ã¦ãƒãƒƒã‚¸ã‚’ç²å¾—ã—ã‚ˆã†ï¼</p>
                
                <div class="badge-container" id="badgeContainer"></div>
            </div>
        </div>

        <!-- ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã‚¿ãƒ– -->
        <div id="timeline" class="tab-content">
            <div class="card">
                <h2>ğŸ“± ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³</h2>
                <p style="color: #6c757d; margin-bottom: 20px;">ãƒ•ãƒ¬ãƒ³ãƒ‰ã¨å‹‰å¼·ã®é€²æ—ã‚’å…±æœ‰ã—ã‚ˆã†ï¼</p>
        
                <div class="timeline-post-form">
                    <h3>ğŸ“ æŠ•ç¨¿ã‚’ä½œæˆ</h3>
                    <div class="input-group">
                        <textarea id="postContent" rows="3" placeholder="ä»Šæ—¥ã®å‹‰å¼·ã«ã¤ã„ã¦æŠ•ç¨¿ã—ã‚ˆã†ï¼ä¾‹ï¼šæ•°å­¦ã‚’30åˆ†å‹‰å¼·ã—ã¾ã—ãŸï¼"></textarea>
                    </div>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <select id="postType" style="padding: 8px; border-radius: 6px; border: 1px solid #dee2e6;">
                            <option value="study">ğŸ“š å‹‰å¼·å ±å‘Š</option>
                            <option value="achievement">ğŸ† é”æˆå ±å‘Š</option>
                            <option value="motivation">ğŸ’ª ãƒ¢ãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³</option>
                            <option value="question">â“ è³ªå•ãƒ»ç›¸è«‡</option>
                        </select>
                        <button class="btn" onclick="createPost()">æŠ•ç¨¿ã™ã‚‹</button>
                    </div>
                </div>
        
                <div class="timeline-container" id="timelineContainer">
                    <!-- ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³æŠ•ç¨¿ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
                </div>
            </div>
        </div>
    </div>

    <!-- Todoè©³ç´°è¿½åŠ ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="todoModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeTodoModal()">&times;</span>
            <h3>ã‚¿ã‚¹ã‚¯ã‚’è¿½åŠ </h3>
            
            <div class="input-group">
                <label for="todoTitle">ã‚¿ã‚¹ã‚¯å:</label>
                <input type="text" id="todoTitle" placeholder="ä¾‹: æ•°å­¦ã®å®¿é¡Œ">
            </div>
            
            <div class="input-group">
                <label for="todoSubject">ç§‘ç›®:</label>
                <select id="todoSubject">
                    <option value="">ç§‘ç›®ã‚’é¸æŠï¼ˆä»»æ„ï¼‰</option>
                </select>
            </div>
            
            <div class="input-group">
                <label for="todoDate">æœŸé™:</label>
                <input type="date" id="todoDate">
            </div>
            
            <div class="input-group">
                <label for="todoNotes">ãƒ¡ãƒ¢:</label>
                <textarea id="todoNotes" rows="3" placeholder="è©³ç´°ã‚„ãƒ¡ãƒ¢ï¼ˆä»»æ„ï¼‰"></textarea>
            </div>
            
            <div style="text-align: center; margin-top: 20px;">
                <button class="btn" onclick="addDetailedTodo()">è¿½åŠ </button>
                <button class="btn btn-secondary" onclick="closeTodoModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            </div>
        </div>
    </div>

    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let timer = null;
        let startTime = 0;
        let elapsedTime = 0;
        let isRunning = false;
        let currentChart = null;
        let currentDate = new Date();
        let selectedDate = new Date();
        let calendarView = 'month';

        // ãƒ‡ãƒ¼ã‚¿ç®¡ç†
        let studyData = {
            subjects: ['æ•°å­¦', 'è‹±èª', 'å›½èª', 'ç†ç§‘', 'ç¤¾ä¼š'],
            todos: [],
            studyTime: {},
            totalTime: 0,
            completedTodos: 0,
            badges: [],
            friends: [
                { 
                    name: 'ã‚ãªãŸ', 
                    time: 0, 
                    tasks: 0,
                    badges: [],
                    avatar: 'ğŸ‘¤',
                    isOwn: true
                },
                { 
                    name: 'ç”°ä¸­ã•ã‚“', 
                    time: 320, 
                    tasks: 25, 
                    badges: ['first_study', 'consistent', 'productive'], 
                    avatar: 'ğŸ‘¨', 
                    isOwn: false 
                },
                { 
                    name: 'ä½è—¤ã•ã‚“', 
                    time: 280, 
                    tasks: 18, 
                    badges: ['first_study', 'consistent'], 
                    avatar: 'ğŸ‘©', 
                    isOwn: false 
                },
                { 
                    name: 'å±±ç”°ã•ã‚“', 
                    time: 150, 
                    tasks: 12, 
                    badges: ['first_study'], 
                    avatar: 'ğŸ‘¦', 
                    isOwn: false 
                }
            ],
            currentRanking: 'time',
            timeline: [],
            comments: {}
        };

        // ãƒãƒƒã‚¸å®šç¾©
// ãƒãƒƒã‚¸å®šç¾© - è¶…é«˜é›£æ˜“åº¦ç‰ˆï¼ˆæ™‚é–“å˜ä½ï¼‰+ é”æˆç‡ãƒ‡ãƒ¼ã‚¿
const badgeDefinitions = [
    // ğŸ”° åˆå¿ƒè€…ãƒãƒƒã‚¸ï¼ˆæ™‚é–“å˜ä½ï¼‰
    { id: 'first_study', name: 'åˆå­¦è€…', icon: 'ğŸ”°', desc: 'åˆå›å‹‰å¼·å®Œäº†', requirement: 1, type: 'time', unit: 'åˆ†', achievementRate: 98.5, rarity: 'common' },
    { id: 'getting_started', name: 'ã‚¹ã‚¿ãƒ¼ãƒˆãƒ€ãƒƒã‚·ãƒ¥', icon: 'ğŸš€', desc: 'ç´¯è¨ˆ3æ™‚é–“å‹‰å¼·é”æˆ', requirement: 3, type: 'time', unit: 'æ™‚é–“', achievementRate: 87.2, rarity: 'common' },
    
    // â° å‹‰å¼·æ™‚é–“ãƒãƒƒã‚¸ï¼ˆè¶…é«˜é›£æ˜“åº¦ãƒ»æ™‚é–“å˜ä½ï¼‰
    { id: 'dedicated', name: 'çŒ®èº«è€…', icon: 'ğŸ’ª', desc: 'ç´¯è¨ˆ10æ™‚é–“å‹‰å¼·é”æˆ', requirement: 10, type: 'time', unit: 'æ™‚é–“', achievementRate: 65.4, rarity: 'uncommon' },
    { id: 'scholar', name: 'å­¦è€…', icon: 'ğŸ“', desc: 'ç´¯è¨ˆ25æ™‚é–“å‹‰å¼·é”æˆ', requirement: 25, type: 'time', unit: 'æ™‚é–“', achievementRate: 42.8, rarity: 'uncommon' },
    { id: 'master', name: 'é”äºº', icon: 'ğŸ‘‘', desc: 'ç´¯è¨ˆ50æ™‚é–“å‹‰å¼·é”æˆ', requirement: 50, type: 'time', unit: 'æ™‚é–“', achievementRate: 28.3, rarity: 'rare' },
    { id: 'expert', name: 'å°‚é–€å®¶', icon: 'ğŸ§ ', desc: 'ç´¯è¨ˆ100æ™‚é–“å‹‰å¼·é”æˆ', requirement: 100, type: 'time', unit: 'æ™‚é–“', achievementRate: 15.7, rarity: 'rare' },
    { id: 'legend', name: 'ä¼èª¬', icon: 'ğŸ†', desc: 'ç´¯è¨ˆ250æ™‚é–“å‹‰å¼·é”æˆ', requirement: 250, type: 'time', unit: 'æ™‚é–“', achievementRate: 8.2, rarity: 'epic' },
    { id: 'ultimate', name: 'ç©¶æ¥µè€…', icon: 'ğŸ’', desc: 'ç´¯è¨ˆ500æ™‚é–“å‹‰å¼·é”æˆ', requirement: 500, type: 'time', unit: 'æ™‚é–“', achievementRate: 4.1, rarity: 'epic' },
    { id: 'transcendent', name: 'è¶…è¶Šè€…', icon: 'ğŸŒŸ', desc: 'ç´¯è¨ˆ1000æ™‚é–“å‹‰å¼·é”æˆ', requirement: 1000, type: 'time', unit: 'æ™‚é–“', achievementRate: 1.8, rarity: 'legendary' },
    { id: 'immortal', name: 'ä¸æ»…è€…', icon: 'âš¡', desc: 'ç´¯è¨ˆ2000æ™‚é–“å‹‰å¼·é”æˆ', requirement: 2000, type: 'time', unit: 'æ™‚é–“', achievementRate: 0.7, rarity: 'legendary' },
    { id: 'divine', name: 'ç¥åŸŸ', icon: 'ğŸ‘¼', desc: 'ç´¯è¨ˆ3000æ™‚é–“å‹‰å¼·é”æˆ', requirement: 3000, type: 'time', unit: 'æ™‚é–“', achievementRate: 0.3, rarity: 'mythical' },
    { id: 'cosmic', name: 'å®‡å®™ç´š', icon: 'ğŸŒŒ', desc: 'ç´¯è¨ˆ5000æ™‚é–“å‹‰å¼·é”æˆ', requirement: 5000, type: 'time', unit: 'æ™‚é–“', achievementRate: 0.12, rarity: 'mythical' },
    { id: 'infinite', name: 'ç„¡é™è€…', icon: 'â™¾ï¸', desc: 'ç´¯è¨ˆ10000æ™‚é–“å‹‰å¼·é”æˆ', requirement: 10000, type: 'time', unit: 'æ™‚é–“', achievementRate: 0.03, rarity: 'transcendent' },
    
    // ğŸ“‹ ã‚¿ã‚¹ã‚¯å®Œäº†ãƒãƒƒã‚¸ï¼ˆè¶…é«˜é›£æ˜“åº¦ï¼‰
    { id: 'productive', name: 'ç”Ÿç”£çš„', icon: 'â­', desc: '100ã‚¿ã‚¹ã‚¯å®Œäº†', requirement: 100, type: 'tasks', achievementRate: 52.6, rarity: 'uncommon' },
    { id: 'task_master', name: 'ã‚¿ã‚¹ã‚¯ãƒã‚¹ã‚¿ãƒ¼', icon: 'âœ…', desc: '500ã‚¿ã‚¹ã‚¯å®Œäº†', requirement: 500, type: 'tasks', achievementRate: 18.4, rarity: 'rare' },
    { id: 'completion_king', name: 'å®Œé‚ç‹', icon: 'ğŸ‘‘', desc: '1000ã‚¿ã‚¹ã‚¯å®Œäº†', requirement: 1000, type: 'tasks', achievementRate: 7.9, rarity: 'epic' },
    { id: 'task_legend', name: 'ã‚¿ã‚¹ã‚¯ä¼èª¬', icon: 'ğŸ…', desc: '2500ã‚¿ã‚¹ã‚¯å®Œäº†', requirement: 2500, type: 'tasks', achievementRate: 2.1, rarity: 'legendary' },
    { id: 'task_god', name: 'ã‚¿ã‚¹ã‚¯ç¥', icon: 'âš¡', desc: '5000ã‚¿ã‚¹ã‚¯å®Œäº†', requirement: 5000, type: 'tasks', achievementRate: 0.6, rarity: 'mythical' },
    { id: 'task_universe', name: 'ã‚¿ã‚¹ã‚¯å®‡å®™', icon: 'ğŸŒŒ', desc: '10000ã‚¿ã‚¹ã‚¯å®Œäº†', requirement: 10000, type: 'tasks', achievementRate: 0.08, rarity: 'transcendent' },
    
    // ğŸ”¥ é€£ç¶šå‹‰å¼·ãƒãƒƒã‚¸ï¼ˆè¶…é•·æœŸï¼‰
    { id: 'consistent_7', name: 'ä¸€é€±é–“æˆ¦å£«', icon: 'ğŸ”¥', desc: '7æ—¥é€£ç¶šå‹‰å¼·', requirement: 7, type: 'streak', achievementRate: 71.3, rarity: 'common' },
    { id: 'consistent_30', name: 'æœˆé–“ãƒãƒ£ãƒ³ãƒ”ã‚ªãƒ³', icon: 'âš¡', desc: '30æ—¥é€£ç¶šå‹‰å¼·', requirement: 30, type: 'streak', achievementRate: 34.7, rarity: 'uncommon' },
    { id: 'consistent_100', name: 'ç™¾æ—¥ä¿®è¡Œè€…', icon: 'ğŸƒ', desc: '100æ—¥é€£ç¶šå‹‰å¼·', requirement: 100, type: 'streak', achievementRate: 12.5, rarity: 'rare' },
    { id: 'consistent_365', name: 'å¹´é–“ãƒã‚¹ã‚¿ãƒ¼', icon: 'ğŸ“…', desc: '365æ—¥é€£ç¶šå‹‰å¼·', requirement: 365, type: 'streak', achievementRate: 2.8, rarity: 'epic' },
    { id: 'consistent_500', name: 'äº”ç™¾æ—¥è–è€…', icon: 'ğŸ§˜', desc: '500æ—¥é€£ç¶šå‹‰å¼·', requirement: 500, type: 'streak', achievementRate: 1.2, rarity: 'legendary' },
    { id: 'consistent_1000', name: 'åƒæ—¥è¡Œè€…', icon: 'â›©ï¸', desc: '1000æ—¥é€£ç¶šå‹‰å¼·', requirement: 1000, type: 'streak', achievementRate: 0.3, rarity: 'mythical' },
    { id: 'consistent_1500', name: 'æ°¸ç¶šè€…', icon: 'ğŸŒ¸', desc: '1500æ—¥é€£ç¶šå‹‰å¼·', requirement: 1500, type: 'streak', achievementRate: 0.09, rarity: 'transcendent' },
    { id: 'consistent_2000', name: 'ä¸å±ˆã®æ„å¿—', icon: 'ğŸ—»', desc: '2000æ—¥é€£ç¶šå‹‰å¼·', requirement: 2000, type: 'streak', achievementRate: 0.02, rarity: 'transcendent' },
    
    // ğŸ“š ç§‘ç›®ãƒãƒƒã‚¸ï¼ˆé«˜é›£æ˜“åº¦ï¼‰
    { id: 'multi_subject_5', name: 'åšå­¦è€…', icon: 'ğŸ“–', desc: '5ç§‘ç›®ä»¥ä¸Šç™»éŒ²', requirement: 5, type: 'subjects', achievementRate: 58.9, rarity: 'uncommon' },
    { id: 'multi_subject_10', name: 'ä¸‡èƒ½å­¦ç¿’è€…', icon: 'ğŸ¤“', desc: '10ç§‘ç›®ä»¥ä¸Šç™»éŒ²', requirement: 10, type: 'subjects', achievementRate: 23.4, rarity: 'rare' },
    { id: 'multi_subject_20', name: 'çŸ¥è­˜ã®æµ·', icon: 'ğŸ§ ', desc: '20ç§‘ç›®ä»¥ä¸Šç™»éŒ²', requirement: 20, type: 'subjects', achievementRate: 6.7, rarity: 'epic' },
    { id: 'multi_subject_50', name: 'å­¦å•ã®ç¥', icon: 'ğŸ“š', desc: '50ç§‘ç›®ä»¥ä¸Šç™»éŒ²', requirement: 50, type: 'subjects', achievementRate: 0.9, rarity: 'mythical' },
    
    // ğŸŒ… ç‰¹åˆ¥æ™‚é–“ãƒãƒƒã‚¸ï¼ˆé«˜é›£æ˜“åº¦ï¼‰
    { id: 'early_bird', name: 'æ—©èµ·ãé³¥', icon: 'ğŸŒ…', desc: 'æœ6æ™‚å‰ã«å‹‰å¼·é–‹å§‹ã‚’50å›', requirement: 50, type: 'early_study', achievementRate: 19.6, rarity: 'rare' },
    { id: 'dawn_warrior', name: 'å¤œæ˜ã‘ã®æˆ¦å£«', icon: 'ğŸŒ„', desc: 'æœ5æ™‚å‰ã«å‹‰å¼·é–‹å§‹ã‚’100å›', requirement: 100, type: 'dawn_study', achievementRate: 4.3, rarity: 'epic' },
    { id: 'night_owl', name: 'å¤œæ›´ã‹ã—å­¦ç¿’è€…', icon: 'ğŸ¦‰', desc: 'å¤œ10æ™‚ä»¥é™ã«å‹‰å¼·é–‹å§‹ã‚’50å›', requirement: 50, type: 'night_study', achievementRate: 31.2, rarity: 'uncommon' },
    { id: 'midnight_scholar', name: 'æ·±å¤œã®å­¦è€…', icon: 'ğŸŒ™', desc: 'å¤œ12æ™‚ä»¥é™ã«å‹‰å¼·é–‹å§‹ã‚’100å›', requirement: 100, type: 'midnight_study', achievementRate: 8.7, rarity: 'epic' },
    { id: 'weekend_warrior', name: 'é€±æœ«æˆ¦å£«', icon: 'ğŸ–ï¸', desc: 'é€±æœ«ã«å‹‰å¼·ã‚’100å›', requirement: 100, type: 'weekend_study', achievementRate: 26.8, rarity: 'uncommon' },
    
    // ğŸ’¯ é›†ä¸­åŠ›ãƒãƒƒã‚¸ï¼ˆè¶…é«˜é›£æ˜“åº¦ãƒ»æ™‚é–“å˜ä½ï¼‰
    { id: 'focused_3h', name: 'é›†ä¸­åŠ›3æ™‚é–“', icon: 'ğŸ¯', desc: '3æ™‚é–“ä»¥ä¸Šã®é€£ç¶šå‹‰å¼·ã‚’25å›', requirement: 25, type: 'long_session_3h', achievementRate: 14.2, rarity: 'rare' },
    { id: 'focused_5h', name: 'é›†ä¸­åŠ›5æ™‚é–“', icon: 'ğŸ”', desc: '5æ™‚é–“ä»¥ä¸Šã®é€£ç¶šå‹‰å¼·ã‚’15å›', requirement: 15, type: 'long_session_5h', achievementRate: 6.8, rarity: 'epic' },
    { id: 'focused_8h', name: 'é›†ä¸­åŠ›8æ™‚é–“', icon: 'âš¡', desc: '8æ™‚é–“ä»¥ä¸Šã®é€£ç¶šå‹‰å¼·ã‚’10å›', requirement: 10, type: 'long_session_8h', achievementRate: 2.4, rarity: 'legendary' },
    { id: 'marathon_runner', name: 'ãƒãƒ©ã‚½ãƒ³ãƒ©ãƒ³ãƒŠãƒ¼', icon: 'ğŸƒâ€â™‚ï¸', desc: '10æ™‚é–“ä»¥ä¸Šã®é€£ç¶šå‹‰å¼·ã‚’5å›', requirement: 5, type: 'marathon_session', achievementRate: 0.8, rarity: 'mythical' },
    { id: 'ultra_marathon', name: 'ã‚¦ãƒ«ãƒˆãƒ©ãƒãƒ©ã‚½ãƒ³', icon: 'ğŸ”ï¸', desc: '12æ™‚é–“ä»¥ä¸Šã®é€£ç¶šå‹‰å¼·ã‚’3å›', requirement: 3, type: 'ultra_marathon', achievementRate: 0.3, rarity: 'transcendent' },
    { id: 'iron_will', name: 'é‰„ã®æ„å¿—', icon: 'âš”ï¸', desc: '15æ™‚é–“ä»¥ä¸Šã®é€£ç¶šå‹‰å¼·ã‚’1å›', requirement: 1, type: 'iron_will', achievementRate: 0.1, rarity: 'transcendent' },
    
    // ğŸ“Š çµ±è¨ˆãƒãƒƒã‚¸ï¼ˆè¶…é«˜é›£æ˜“åº¦ãƒ»æ™‚é–“å˜ä½ï¼‰
    { id: 'daily_goal_30', name: 'æœˆé–“ç›®æ¨™é”æˆè€…', icon: 'ğŸª', desc: '1æ—¥2æ™‚é–“ã‚’30æ—¥é”æˆ', requirement: 30, type: 'daily_goal_2h', achievementRate: 22.1, rarity: 'rare' },
    { id: 'daily_goal_100', name: 'ç™¾æ—¥ç›®æ¨™é”æˆè€…', icon: 'ğŸ­', desc: '1æ—¥2æ™‚é–“ã‚’100æ—¥é”æˆ', requirement: 100, type: 'daily_goal_2h', achievementRate: 9.3, rarity: 'epic' },
    { id: 'daily_goal_365', name: 'å¹´é–“ç›®æ¨™é”æˆè€…', icon: 'ğŸ¨', desc: '1æ—¥2æ™‚é–“ã‚’365æ—¥é”æˆ', requirement: 365, type: 'daily_goal_2h', achievementRate: 1.7, rarity: 'legendary' },
    { id: 'perfectionist', name: 'å®Œç’§ä¸»ç¾©è€…', icon: 'ğŸ’¯', desc: 'äºˆå®šã—ãŸã‚¿ã‚¹ã‚¯ã‚’100%å®Œäº†ã‚’50æ—¥', requirement: 50, type: 'perfect_day', achievementRate: 11.4, rarity: 'rare' },
    { id: 'ultra_perfectionist', name: 'ç©¶æ¥µå®Œç’§ä¸»ç¾©è€…', icon: 'âœ¨', desc: 'äºˆå®šã—ãŸã‚¿ã‚¹ã‚¯ã‚’100%å®Œäº†ã‚’200æ—¥', requirement: 200, type: 'perfect_day', achievementRate: 2.6, rarity: 'legendary' },
    
    // ğŸš€ ã‚¹ãƒšã‚·ãƒ£ãƒ«ãƒãƒƒã‚¸ï¼ˆè¶…é«˜é›£æ˜“åº¦ãƒ»æ™‚é–“å˜ä½ï¼‰
    { id: 'speed_demon', name: 'ã‚¹ãƒ”ãƒ¼ãƒ‰ãƒ‡ãƒ¼ãƒ¢ãƒ³', icon: 'âš¡', desc: '1æ—¥ã§50ã‚¿ã‚¹ã‚¯å®Œäº†', requirement: 50, type: 'daily_tasks', achievementRate: 3.2, rarity: 'epic' },
    { id: 'task_hurricane', name: 'ã‚¿ã‚¹ã‚¯ãƒãƒªã‚±ãƒ¼ãƒ³', icon: 'ğŸŒªï¸', desc: '1æ—¥ã§100ã‚¿ã‚¹ã‚¯å®Œäº†', requirement: 100, type: 'daily_tasks', achievementRate: 0.4, rarity: 'mythical' },
    { id: 'time_master', name: 'ã‚¿ã‚¤ãƒ ãƒã‚¹ã‚¿ãƒ¼', icon: 'â°', desc: '1æ—¥ã§10æ™‚é–“å‹‰å¼·', requirement: 10, type: 'daily_time', achievementRate: 5.7, rarity: 'epic' },
    { id: 'time_lord', name: 'ã‚¿ã‚¤ãƒ ãƒ­ãƒ¼ãƒ‰', icon: 'ğŸŒŒ', desc: '1æ—¥ã§15æ™‚é–“å‹‰å¼·', requirement: 15, type: 'daily_time', achievementRate: 1.1, rarity: 'legendary' },
    { id: 'time_god', name: 'ã‚¿ã‚¤ãƒ ç¥', icon: 'âš¡', desc: '1æ—¥ã§20æ™‚é–“å‹‰å¼·', requirement: 20, type: 'daily_time', achievementRate: 0.2, rarity: 'transcendent' },
    { id: 'comeback_kid', name: 'ã‚«ãƒ ãƒãƒƒã‚¯ã‚­ãƒƒãƒ‰', icon: 'ğŸ”„', desc: '30æ—¥é–“ä¼‘ã‚“ã å¾Œã«å‹‰å¼·å†é–‹', requirement: 1, type: 'comeback', achievementRate: 16.8, rarity: 'rare' },
    
    // ğŸ† ãƒ¬ã‚¸ã‚§ãƒ³ãƒ‰ãƒãƒƒã‚¸ï¼ˆæœ€é«˜é›£æ˜“åº¦ãƒ»æ™‚é–“å˜ä½ï¼‰
    { id: 'study_god', name: 'å‹‰å¼·ç¥', icon: 'âš¡', desc: 'å…¨ã¦ã®åŸºæœ¬ãƒãƒƒã‚¸ã‚’ç²å¾—', requirement: 1, type: 'meta', achievementRate: 3.4, rarity: 'epic' },
    { id: 'monthly_titan', name: 'æœˆé–“ã‚¿ã‚¤ã‚¿ãƒ³', icon: 'ğŸŒŒ', desc: 'æœˆé–“200æ™‚é–“å‹‰å¼·ã‚’6ãƒ¶æœˆé€£ç¶š', requirement: 6, type: 'monthly_titan', achievementRate: 0.6, rarity: 'mythical' },
    { id: 'yearly_emperor', name: 'å¹´é–“çš‡å¸', icon: 'ğŸ‘‘', desc: 'å¹´é–“2000æ™‚é–“å‹‰å¼·é”æˆ', requirement: 2000, type: 'yearly_time', achievementRate: 0.4, rarity: 'mythical' },
    { id: 'decade_legend', name: 'åå¹´ä¼èª¬', icon: 'ğŸ›ï¸', desc: '10å¹´é–“ã§10000æ™‚é–“å‹‰å¼·é”æˆ', requirement: 10000, type: 'decade_time', achievementRate: 0.08, rarity: 'transcendent' },
    { id: 'ultimate_scholar', name: 'ç©¶æ¥µå­¦è€…', icon: 'ğŸ”®', desc: 'ç”Ÿæ¶¯20000æ™‚é–“å‹‰å¼·é”æˆ', requirement: 20000, type: 'lifetime', achievementRate: 0.02, rarity: 'transcendent' },
    { id: 'eternal_student', name: 'æ°¸é ã®å­¦ç”Ÿ', icon: 'â™¾ï¸', desc: 'ç”Ÿæ¶¯50000æ™‚é–“å‹‰å¼·é”æˆ', requirement: 50000, type: 'lifetime', achievementRate: 0.005, rarity: 'transcendent' },
    
    // ğŸŒŸ ç¥è©±ç´šãƒãƒƒã‚¸ï¼ˆä¼èª¬ã®é›£æ˜“åº¦ï¼‰
    { id: 'mythical_sage', name: 'ç¥è©±ã®è³¢è€…', icon: 'ğŸ§™â€â™‚ï¸', desc: 'é€£ç¶š3å¹´é–“æ¯æ—¥5æ™‚é–“å‹‰å¼·', requirement: 1095, type: 'mythical_streak', achievementRate: 0.01, rarity: 'transcendent' },
    { id: 'cosmic_scholar', name: 'å®‡å®™å­¦è€…', icon: 'ğŸŒ ', desc: '100ç§‘ç›®ã§å„100æ™‚é–“å‹‰å¼·', requirement: 100, type: 'cosmic_mastery', achievementRate: 0.003, rarity: 'transcendent' },
    { id: 'time_transcendent', name: 'æ™‚ç©ºè¶…è¶Šè€…', icon: 'â³', desc: '1æ—¥24æ™‚é–“ä¸­20æ™‚é–“å‹‰å¼·ã‚’7æ—¥é€£ç¶š', requirement: 7, type: 'time_transcendent', achievementRate: 0.001, rarity: 'transcendent' },
    { id: 'knowledge_singularity', name: 'çŸ¥è­˜ç‰¹ç•°ç‚¹', icon: 'ğŸŒŒ', desc: 'å…¨ã¦ã®ãƒãƒƒã‚¸ã‚’ç²å¾—', requirement: 1, type: 'singularity', achievementRate: 0.0001, rarity: 'transcendent' }
];

        // åˆæœŸåŒ–
        window.onload = function() {
            loadData();
            loadSubjects();
            updateSelectedDate();
            renderCalendar();
            loadTodos();
            updateStats();
            createChart();
            loadBadges();
            loadFriendRanking();
            loadBadgeProgress();
            updateTimerStats();
        };

        // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ãƒ»ä¿å­˜
        function loadData() {
            const saved = localStorage.getItem('studyBuildData');
            if (saved) {
                try {
                    const savedData = JSON.parse(saved);
                    studyData = { ...studyData, ...savedData };

                    // ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã«æ®‹ã£ãŸå¤ã„ã‚µãƒ³ãƒ—ãƒ«ãƒ•ãƒ¬ãƒ³ãƒ‰ã‚„æ¶ç©ºã®è¨˜éŒ²ã‚’å‰Šé™¤ã™ã‚‹
                    // ã‚µãƒ³ãƒ—ãƒ«åã«ãƒãƒƒãƒã™ã‚‹ã‚‚ã®ã€ã¾ãŸã¯è‡ªåˆ†ä»¥å¤–ã§ä¸è‡ªç„¶ã«çµ±è¨ˆãŒå…¥ã£ã¦ã„ã‚‹ã‚‚ã®ã‚’å‰Šé™¤
                    const sampleNames = ['ç”°ä¸­ã•ã‚“', 'ä½è—¤ã•ã‚“', 'å±±ç”°ã•ã‚“'];
                    studyData.friends = (studyData.friends || []).filter(f => {
                        if (f.isOwn) return true;
                        if (sampleNames.includes(f.name)) return false;
                        // time/tasks/badges ã«å€¤ãŒå…¥ã£ã¦ã„ã‚‹ï¼ˆï¼è‡ªå‹•ã§ç”Ÿæˆã•ã‚ŒãŸå¯èƒ½æ€§ï¼‰ã®å ´åˆå‰Šé™¤
                        const hasStats = (f.time && f.time > 0) || (f.tasks && f.tasks > 0) || (f.badges && f.badges.length > 0);
                        return !hasStats;
                    });
                    // ä¸Šæ›¸ãä¿å­˜ã—ã¦å¤ã„ãƒ‡ãƒ¼ã‚¿ã‚’æ¶ˆå»
                    try { localStorage.setItem('studyBuildData', JSON.stringify(studyData)); } catch (e) { /* ignore */ }
                } catch (e) {
                    console.log('ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
            }
        }

        function saveData() {
            localStorage.setItem('studyBuildData', JSON.stringify(studyData));
        }

        // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
        function showTab(tabName) {
            const tabs = document.querySelectorAll('.tab-content');
            tabs.forEach(tab => tab.classList.remove('active'));
            
            const buttons = document.querySelectorAll('.tab-btn');
            buttons.forEach(btn => btn.classList.remove('active'));
            
            document.getElementById(tabName).classList.add('active');
            // å‘¼ã³å‡ºã—å…ƒãƒœã‚¿ãƒ³ãŒæ¸¡ã•ã‚Œãªã„å ´åˆãŒã‚ã‚‹ãŸã‚ã€onclick å±æ€§ã§ãƒœã‚¿ãƒ³ã‚’æ¤œç´¢ã—ã¦ active ã‚’ä»˜ä¸
            const btn = document.querySelector(`.tab-btn[onclick="showTab('${tabName}')"]`);
            if (btn) btn.classList.add('active');

            if (tabName === 'stats') {
                setTimeout(() => {
                    createChart();
                    loadFriendRanking();
                    loadBadgeProgress();
                }, 100);
            } else if (tabName === 'planner') {
                renderCalendar();
                loadTodos();
            } else if (tabName === 'badges') {
                loadBadges();
            } else if (tabName === 'timeline') {
                loadTimeline();
            }
        }

        // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æ©Ÿèƒ½
        function renderCalendar() {
            const monthNames = ['1æœˆ', '2æœˆ', '3æœˆ', '4æœˆ', '5æœˆ', '6æœˆ', '7æœˆ', '8æœˆ', '9æœˆ', '10æœˆ', '11æœˆ', '12æœˆ'];
            const dayNames = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
            
            document.getElementById('currentMonth').textContent = 
                currentDate.getFullYear() + 'å¹´ ' + monthNames[currentDate.getMonth()];
            
            const calendarGrid = document.getElementById('calendarGrid');
            calendarGrid.innerHTML = '';
            
            // æ›œæ—¥ãƒ˜ãƒƒãƒ€ãƒ¼
            dayNames.forEach(day => {
                const dayHeader = document.createElement('div');
                dayHeader.className = 'calendar-day';
                dayHeader.innerHTML = `<div class="calendar-day-number" style="font-weight: bold; color: #0d6efd;">${day}</div>`;
                calendarGrid.appendChild(dayHeader);
            });
            
            if (calendarView === 'month') {
                renderMonthView(calendarGrid);
            } else {
                renderWeekView(calendarGrid);
            }
        }

        function renderMonthView(calendarGrid) {
            const firstDay = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
            const lastDay = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0);
            const startDate = new Date(firstDay);
            startDate.setDate(startDate.getDate() - firstDay.getDay());
            
            for (let i = 0; i < 42; i++) {
                const date = new Date(startDate);
                date.setDate(startDate.getDate() + i);
                
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day';
                dayElement.onclick = () => selectDate(date);
                
                const dayNumber = document.createElement('div');
                dayNumber.className = 'calendar-day-number';
                dayNumber.textContent = date.getDate();
                dayElement.appendChild(dayNumber);
                
                if (date.getMonth() !== currentDate.getMonth()) {
                    dayElement.classList.add('other-month');
                }
                
                if (date.toDateString() === new Date().toDateString()) {
                    dayElement.classList.add('today');
                }
                
                if (date.toDateString() === selectedDate.toDateString()) {
                    dayElement.classList.add('selected');
                }
                
                // ãã®æ—¥ã®Todoã‚’è¡¨ç¤º
                const dayTodos = getTodosForDate(date);
                dayTodos.forEach(todo => {
                    const todoElement = document.createElement('div');
                    todoElement.className = 'calendar-todo';
                    if (todo.completed) {
                        todoElement.classList.add('completed');
                    } else if (new Date(todo.dueDate) < new Date() && !todo.completed) {
                        todoElement.classList.add('overdue');
                    }
                    todoElement.textContent = todo.title;
                    todoElement.onclick = (e) => {
                        e.stopPropagation();
                        selectDate(date);
                    };
                    dayElement.appendChild(todoElement);
                });
                
                calendarGrid.appendChild(dayElement);
            }
        }

        function renderWeekView(calendarGrid) {
            const weekStart = new Date(selectedDate);
            weekStart.setDate(selectedDate.getDate() - selectedDate.getDay());
            
            for (let i = 0; i < 7; i++) {
                const date = new Date(weekStart);
                date.setDate(weekStart.getDate() + i);
                
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day';
                dayElement.onclick = () => selectDate(date);
                dayElement.style.minHeight = '120px';
                
                const dayNumber = document.createElement('div');
                dayNumber.className = 'calendar-day-number';
                dayNumber.textContent = date.getDate();
                dayElement.appendChild(dayNumber);
                
                if (date.toDateString() === new Date().toDateString()) {
                    dayElement.classList.add('today');
                }
                
                if (date.toDateString() === selectedDate.toDateString()) {
                    dayElement.classList.add('selected');
                }
                
                // ãã®æ—¥ã®Todoã‚’è¡¨ç¤º
                const dayTodos = getTodosForDate(date);
                dayTodos.forEach(todo => {
                    const todoElement = document.createElement('div');
                    todoElement.className = 'calendar-todo';
                    if (todo.completed) {
                        todoElement.classList.add('completed');
                    } else if (new Date(todo.dueDate) < new Date() && !todo.completed) {
                        todoElement.classList.add('overdue');
                    }
                    todoElement.textContent = todo.title;
                    todoElement.onclick = (e) => {
                        e.stopPropagation();
                        selectDate(date);
                    };
                    dayElement.appendChild(todoElement);
                });
                
                calendarGrid.appendChild(dayElement);
            }
        }

        function changeMonth(direction) {
            currentDate.setMonth(currentDate.getMonth() + direction);
            renderCalendar();
        }

        function setCalendarView(view) {
            calendarView = view;
            document.querySelectorAll('.view-btn').forEach(btn => btn.classList.remove('active'));
            const btn = document.querySelector(`.view-btn[onclick="setCalendarView('${view}')"]`);
            if (btn) btn.classList.add('active');
            renderCalendar();
        }

        function getDateString(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function selectDate(date) {
            selectedDate = new Date(date);
            updateSelectedDate();
            loadTodos();
            renderCalendar();
        }

        function updateSelectedDate() {
            const options = { month: 'long', day: 'numeric', weekday: 'long' };
            const dateStr = selectedDate.toLocaleDateString('ja-JP', options);
            document.getElementById('selectedDateHeader').textContent = 
                selectedDate.toDateString() === new Date().toDateString() ? 'ä»Šæ—¥ã®ã‚¿ã‚¹ã‚¯' : dateStr + 'ã®ã‚¿ã‚¹ã‚¯';
        }

        // Todoæ©Ÿèƒ½
        function getTodosForDate(date) {
            const dateStr = getDateString(date);
            return studyData.todos.filter(todo => todo.dueDate === dateStr);
        }

        function addQuickTodo() {
            const input = document.getElementById('quickTodoInput');
            const title = input.value.trim();
            
            if (title) {
                const todo = {
                    id: Date.now(),
                    title: title,
                    subject: '',
                    dueDate: getDateString(selectedDate), // ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³å¯¾å¿œ
                    notes: '',
                    completed: false,
                    createdAt: new Date().toISOString()
                };
                
                studyData.todos.push(todo);
                input.value = '';
                saveData();
                loadTodos();
                renderCalendar();
            }
        }

        function openTodoModal() {
            document.getElementById('todoModal').style.display = 'block';
            document.getElementById('todoDate').value = getDateString(selectedDate);
            
            // ç§‘ç›®é¸æŠè‚¢ã‚’æ›´æ–°
            const todoSubject = document.getElementById('todoSubject');
            todoSubject.innerHTML = '<option value="">ç§‘ç›®ã‚’é¸æŠï¼ˆä»»æ„ï¼‰</option>';
            studyData.subjects.forEach(subject => {
                const option = document.createElement('option');
                option.value = subject;
                option.textContent = subject;
                todoSubject.appendChild(option);
            });
        }

        function closeTodoModal() {
            document.getElementById('todoModal').style.display = 'none';
            document.getElementById('todoTitle').value = '';
            document.getElementById('todoSubject').value = '';
            document.getElementById('todoDate').value = '';
            document.getElementById('todoNotes').value = '';
        }

        function addDetailedTodo() {
            const title = document.getElementById('todoTitle').value.trim();
            const subject = document.getElementById('todoSubject').value;
            const dueDate = document.getElementById('todoDate').value;
            const notes = document.getElementById('todoNotes').value.trim();
            
            if (title && dueDate) {
                const todo = {
                    id: Date.now(),
                    title: title,
                    subject: subject,
                    dueDate: dueDate, // ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³å¯¾å¿œæ¸ˆã¿
                    notes: notes,
                    completed: false,
                    createdAt: new Date().toISOString()
                };
                
                studyData.todos.push(todo);
                saveData();
                loadTodos();
                renderCalendar();
                closeTodoModal();
                
                // è¿½åŠ ã—ãŸæ—¥ä»˜ã‚’é¸æŠ
                selectDate(new Date(dueDate));
            }
        }

        function loadTodos() {
            const todoList = document.getElementById('todoList');
            todoList.innerHTML = '';
            
            const selectedTodos = getTodosForDate(selectedDate);
            
            if (selectedTodos.length === 0) {
                todoList.innerHTML = '<p style="color: #6c757d; text-align: center; padding: 20px;">ã“ã®æ—¥ã«ã¯ã‚¿ã‚¹ã‚¯ãŒã‚ã‚Šã¾ã›ã‚“</p>';
                return;
            }
            
            selectedTodos.forEach(todo => {
                const todoItem = document.createElement('div');
                todoItem.className = 'todo-item';
                
                // æœŸé™ã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³ã§æ¯”è¼ƒ
                const dueDateTZ = new Date(todo.dueDate + 'T00:00:00'); // ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³ã‚’è€ƒæ…®ã—ãŸæ—¥ä»˜ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
                const isOverdue = dueDateTZ < new Date() && !todo.completed;

                if (todo.completed) {
                    todoItem.classList.add('completed');
                } else if (isOverdue) {
                    todoItem.classList.add('overdue');
                }
                
                todoItem.innerHTML = `
                    <input type="checkbox" class="todo-checkbox" ${todo.completed ? 'checked' : ''} 
                           onchange="toggleTodo(${todo.id})">
                    <div class="todo-content">
                        <div class="todo-text ${todo.completed ? 'completed' : ''}">${todo.title}</div>
                        <div class="todo-meta">
                            ${todo.subject ? `ğŸ“š ${todo.subject}` : ''}
                            ${todo.notes ? `ğŸ“ ${todo.notes}` : ''}
                        </div>
                    </div>
                    <div class="todo-actions">
                        <button class="btn btn-small btn-secondary" onclick="deleteTodo(${todo.id})">å‰Šé™¤</button>
                    </div>
                `;
                
                todoList.appendChild(todoItem);
            });
        }

        function toggleTodo(id) {
            const todo = studyData.todos.find(t => t.id === id);
            if (todo) {
                todo.completed = !todo.completed;
                if (todo.completed) {
                    studyData.completedTodos++;
                    // ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã«è‡ªå‹•æŠ•ç¨¿
                    createAutoPost('task_complete', { title: todo.title });
                } else {
                    studyData.completedTodos--;
                }
                saveData();
                loadTodos();
                renderCalendar();
                updateStats();
                checkBadges();
            }
        }

        function deleteTodo(id) {
            const index = studyData.todos.findIndex(t => t.id === id);
            if (index > -1) {
                if (studyData.todos[index].completed) {
                    studyData.completedTodos--;
                }
                studyData.todos.splice(index, 1);
                saveData();
                loadTodos();
                renderCalendar();
                updateStats();
            }
        }

        // ã‚¿ã‚¤ãƒãƒ¼æ©Ÿèƒ½ã®æ”¹å–„
function startTimer() {
    if (!isRunning) {
        startTime = Date.now() - elapsedTime;
        timer = setInterval(updateTimer, 1000);
        isRunning = true;
        const startBtn = document.getElementById('startBtn');
        startBtn.textContent = 'ğŸ”„ å®Ÿè¡Œä¸­...';
        startBtn.classList.add('running');
    }
}

function pauseTimer() {
    if (isRunning) {
        clearInterval(timer);
        isRunning = false;
        const startBtn = document.getElementById('startBtn');
        startBtn.textContent = 'â–¶ï¸ å†é–‹';
        startBtn.classList.remove('running');
    }
}

function stopTimer() {
    if (elapsedTime > 0) {
        const subject = document.getElementById('subjectSelect').value;
        const minutes = Math.floor(elapsedTime / 60000);
        
        if (subject && minutes > 0) {
            if (!studyData.studyTime[subject]) {
                studyData.studyTime[subject] = 0;
            }
            studyData.studyTime[subject] += minutes;
            studyData.totalTime += minutes;
            
            checkBadges();
            saveData();
            updateStats();
            updateTimerStats();
            createChart();
            
            // æˆåŠŸã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
            showSuccessMessage(subject, minutes);

            // ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã«è‡ªå‹•æŠ•ç¨¿
            createAutoPost('study_complete', { subject: subject, minutes: minutes });
        }
    }
    
    clearInterval(timer);
    elapsedTime = 0;
    isRunning = false;
    const startBtn = document.getElementById('startBtn');
    startBtn.textContent = 'â–¶ï¸ é–‹å§‹';
    startBtn.classList.remove('running');
    document.getElementById('timerDisplay').textContent = '00:00:00';
    updateTimerStats();
}

function updateTimer() {
    elapsedTime = Date.now() - startTime;
    const hours = Math.floor(elapsedTime / 3600000);
    const minutes = Math.floor((elapsedTime % 3600000) / 60000);
    const seconds = Math.floor((elapsedTime % 60000) / 1000);
    
    const h = hours < 10 ? '0' + hours : hours;
    const m = minutes < 10 ? '0' + minutes : minutes;
    const s = seconds < 10 ? '0' + seconds : seconds;
    
    document.getElementById('timerDisplay').textContent = h + ':' + m + ':' + s;
    updateTimerStats();
}

function updateTimerStats() {
    const currentMinutes = Math.floor(elapsedTime / 60000);
    document.getElementById('currentSession').textContent = currentMinutes;
    
    // ä»Šæ—¥ã®å‹‰å¼·æ™‚é–“ã‚’è¨ˆç®—ï¼ˆç°¡ç•¥åŒ–ï¼‰
    const todayTime = Math.floor(studyData.totalTime * 0.4); // ä»®ã®è¨ˆç®—
    document.getElementById('todayStudyTime').textContent = todayTime;
}

function showSuccessMessage(subject, minutes) {
    // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã‚ˆã‚Šé­…åŠ›çš„ã«
    const message = `ğŸ‰ ç´ æ™´ã‚‰ã—ã„ï¼\n\nğŸ“š ${subject}\nâ° ${minutes}åˆ†é–“\n\né›†ä¸­ã—ã¦å‹‰å¼·ã§ãã¾ã—ãŸï¼\nãŠç–²ã‚Œæ§˜ã§ã—ãŸï¼ ğŸ’ªâœ¨`;
    alert(message);
}

        // ç§‘ç›®ç®¡ç†
        function addSubject() {
            const input = document.getElementById('subjectInput');
            const subject = input.value.trim();
            
            if (subject && studyData.subjects.indexOf(subject) === -1) {
                studyData.subjects.push(subject);
                input.value = '';
                saveData();
                loadSubjects();
                updateStats();
            }
        }

        function deleteSubject(subject) {
            const index = studyData.subjects.indexOf(subject);
            if (index > -1) {
                studyData.subjects.splice(index, 1);
                delete studyData.studyTime[subject];
                saveData();
                loadSubjects();
                updateStats();
                createChart();
            }
        }

        function loadSubjects() {
            const subjectList = document.getElementById('subjectList');
            const subjectSelect = document.getElementById('subjectSelect');
            
            subjectList.innerHTML = '';
            subjectSelect.innerHTML = '<option value="">ç§‘ç›®ã‚’é¸æŠã—ã¦ãã ã•ã„</option>';
            
            studyData.subjects.forEach(subject => {
                const time = studyData.studyTime[subject] || 0;
                
                const subjectItem = document.createElement('div');
                subjectItem.className = 'todo-item';
                subjectItem.innerHTML = `
                    <div class="todo-content">
                        <div class="todo-text">${subject}</div>
                        <div class="todo-meta">å‹‰å¼·æ™‚é–“: ${time}åˆ†</div>
                    </div>
                    <div class="todo-actions">
                        <button class="btn btn-small btn-secondary" onclick="deleteSubject('${subject}')">å‰Šé™¤</button>
                    </div>
                `;
                subjectList.appendChild(subjectItem);
                
                const option = document.createElement('option');
                option.value = subject;
                option.textContent = subject;
                subjectSelect.appendChild(option);
            });
        }

        // ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒ©ãƒ³ã‚­ãƒ³ã‚°æ©Ÿèƒ½
        function showRanking(type) {
            studyData.currentRanking = type;
            document.querySelectorAll('.ranking-tab-btn').forEach(btn => btn.classList.remove('active'));
            const btn = document.querySelector(`.ranking-tab-btn[onclick="showRanking('${type}')"]`);
            if (btn) btn.classList.add('active');
            loadFriendRanking();
        }

        function loadFriendRanking() {
            const friendRanking = document.getElementById('friendRanking');
            if (!friendRanking) return;
            
            friendRanking.innerHTML = '';
            
            // ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°
            studyData.friends[0].time = studyData.totalTime;
            studyData.friends[0].tasks = studyData.completedTodos;
            studyData.friends[0].badges = studyData.badges;
            
            // ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚½ãƒ¼ãƒˆ
            let sortedFriends = [...studyData.friends];

            // ãƒ•ãƒ¬ãƒ³ãƒ‰ãŒè‡ªåˆ†ã®ã¿ï¼ˆè¿½åŠ ã•ã‚ŒãŸãƒ•ãƒ¬ãƒ³ãƒ‰ãŒã„ãªã„ï¼‰å ´åˆã¯æ¡ˆå†…ã‚’è¡¨ç¤º
            const nonOwnFriends = sortedFriends.filter(f => !f.isOwn);
            if (nonOwnFriends.length === 0) {
                friendRanking.innerHTML = '<div class="no-friends" style="padding:16px;color:#6c757d;">ãƒ•ãƒ¬ãƒ³ãƒ‰ã‚’è¿½åŠ ã—ã¦ãã ã•ã„</div>';
                return;
            }
            switch (studyData.currentRanking) {
                case 'time':
                    sortedFriends.sort((a, b) => b.time - a.time);
                    break;
                case 'tasks':
                    sortedFriends.sort((a, b) => b.tasks - a.tasks);
                    break;
                case 'badges':
                    sortedFriends.sort((a, b) => b.badges.length - a.badges.length);
                    break;
            }
            
            sortedFriends.forEach((friend, index) => {
                const rankingItem = document.createElement('div');
                rankingItem.className = 'ranking-item' + (friend.isOwn ? ' own' : '');
                
                let rankClass = '';
                if (index === 0) rankClass = 'gold';
                else if (index === 1) rankClass = 'silver';
                else if (index === 2) rankClass = 'bronze';
                
                let scoreValue = '';
                switch (studyData.currentRanking) {
                    case 'time':
                        scoreValue = friend.time + 'åˆ†';
                        break;
                    case 'tasks':
                        scoreValue = friend.tasks + 'å€‹';
                        break;
                    case 'badges':
                        scoreValue = friend.badges.length + 'å€‹';
                        break;
                }
                
                rankingItem.innerHTML = `
                    <div class="rank-badge ${rankClass}">${index + 1}</div>
                    <div class="friend-info">
                        <div class="friend-avatar">${friend.avatar}</div>
                        <div class="friend-details">
                            <div class="friend-name">${friend.name}${friend.isOwn ? ' (ã‚ãªãŸ)' : ''}</div>
                            <div class="friend-stats">
                                å‹‰å¼·æ™‚é–“: ${friend.time}åˆ† | ã‚¿ã‚¹ã‚¯: ${friend.tasks}å€‹ | ãƒãƒƒã‚¸: ${friend.badges.length}å€‹
                            </div>
                            <div class="friend-badges">
                                ${friend.badges.slice(0, 5).map(badgeId => {
                                    const badge = badgeDefinitions.find(b => b.id === badgeId);
                                    return badge ? `<span class="mini-badge earned">${badge.icon}</span>` : '';
                                }).join('')}
                                ${friend.badges.length > 5 ? `<span class="mini-badge">+${friend.badges.length - 5}</span>` : ''}
                            </div>
                        </div>
                    </div>
                    <div class="ranking-score">${scoreValue}</div>
                    ${index === 0 ? '<div class="crown-icon">ğŸ‘‘</div>' : ''}
                `;
                
                friendRanking.appendChild(rankingItem);
            });
        }

        function openFriendModal() {
            const friendName = prompt('ãƒ•ãƒ¬ãƒ³ãƒ‰ã®åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:');
            if (friendName && friendName.trim()) {
                const trimmed = friendName.trim();
                const confirmText = prompt(`${trimmed} ã•ã‚“ã‚’æœ¬å½“ã«ãƒ•ãƒ¬ãƒ³ãƒ‰ã«è¿½åŠ ã—ã¾ã™ã‹ï¼Ÿ\nç›¸æ‰‹ã®åŒæ„ãŒã‚ã‚‹å ´åˆã¯ã€Œè¿½åŠ ã€ã¨å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚`);
                if (confirmText && confirmText.trim() === 'è¿½åŠ ') {
                    addFriend(trimmed);
                } else {
                    alert('ãƒ•ãƒ¬ãƒ³ãƒ‰è¿½åŠ ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸã€‚ç›¸æ‰‹ã®åŒæ„ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
                }
            }
        }

        function addFriend(name) {
            // åŸºæœ¬ãƒã‚§ãƒƒã‚¯
            if (!name || name.length < 2) {
                alert('åå‰ã¯2æ–‡å­—ä»¥ä¸Šã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                return;
            }

            // ä¸æ­£ï¼æ¶ç©ºã¨æ€ã‚ã‚Œã‚‹åå‰ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’æ’é™¤
            const lower = name.toLowerCase();
            const suspiciousPatterns = [/^[0-9]+$/u, /æ¶ç©º/u, /ãƒ†ã‚¹ãƒˆ/u, /test/u, /dummy/u, /bot/u];
            for (const pat of suspiciousPatterns) {
                if (pat.test(name) || pat.test(lower)) {
                    alert('ç„¡åŠ¹ãªåå‰ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸã€‚æ­£ã—ã„åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                    return;
                }
            }

            const exists = studyData.friends.find(f => f.name === name);
            if (exists) {
                alert('ãã®ãƒ•ãƒ¬ãƒ³ãƒ‰ã¯æ—¢ã«è¿½åŠ ã•ã‚Œã¦ã„ã¾ã™ã€‚');
                return;
            }

            const avatars = ['ğŸ‘¨', 'ğŸ‘©', 'ğŸ‘¦', 'ğŸ‘§', 'ğŸ§‘', 'ğŸ‘´', 'ğŸ‘µ', 'ğŸ§’', 'ğŸ‘±', 'ğŸ§”'];
            const randomAvatar = avatars[Math.floor(Math.random() * avatars.length)];

            // è‡ªå‹•ã§æ¶ç©ºãƒ‡ãƒ¼ã‚¿ã‚’å‰²ã‚Šå½“ã¦ãšã€å®Ÿéš›ã®ç›¸æ‰‹ã®ãƒ‡ãƒ¼ã‚¿ã‚’å¾…ã¤ï¼ˆåˆæœŸå€¤ã¯ã‚¼ãƒ­ã¾ãŸã¯ç©ºï¼‰
            studyData.friends.push({
                name: name,
                time: 0,
                tasks: 0,
                badges: [],
                avatar: randomAvatar,
                isOwn: false
            });

            saveData();
            loadFriendRanking();
            alert(`${name}ã•ã‚“ã‚’ãƒ•ãƒ¬ãƒ³ãƒ‰ã«è¿½åŠ ã—ã¾ã—ãŸï¼ˆçµ±è¨ˆã¯ç›¸æ‰‹ã®ãƒ‡ãƒ¼ã‚¿å—é ˜å¾Œã«æ›´æ–°ã•ã‚Œã¾ã™ï¼‰ã€‚`);
        }

        function generateRandomBadges() {
            const badges = [];
            const availableBadges = ['first_study', 'consistent', 'productive', 'dedicated'];
            const count = Math.floor(Math.random() * 4) + 1;
            
            for (let i = 0; i < count; i++) {
                const randomBadge = availableBadges[Math.floor(Math.random() * availableBadges.length)];
                if (!badges.includes(randomBadge)) {
                    badges.push(randomBadge);
                }
            }
            
            return badges;
        }

            // --- Barcode scanner + OpenBD integration ---
            let scannerActive = false;

            function openScanner() {
                const modal = document.getElementById('scannerModal');
                if (!modal) return;
                modal.classList.add('active');
                document.getElementById('scannerResult').textContent = '';
            }

            function closeScanner() {
                stopScanner();
                const modal = document.getElementById('scannerModal');
                if (!modal) return;
                modal.classList.remove('active');
            }

            function startScanner() {
                if (scannerActive) return;
                const target = document.getElementById('scannerVideo');
                if (!target) { alert('å‹•ç”»è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“'); return; }

                document.getElementById('scannerResult').textContent = 'ã‚«ãƒ¡ãƒ©ã‚’åˆæœŸåŒ–ã—ã¦ã„ã¾ã™...';
                Quagga.init({
                    inputStream: {
                        name: 'Live',
                        type: 'LiveStream',
                        target: target,
                        constraints: { facingMode: 'environment' }
                    },
                    decoder: { readers: ['ean_reader','ean_13_reader','upc_reader'] },
                    locate: true
                }, function(err) {
                    if (err) {
                        console.error(err);
                        document.getElementById('scannerResult').textContent = 'ã‚«ãƒ¡ãƒ©ã®èµ·å‹•ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã®æ¨©é™ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
                        return;
                    }
                    Quagga.start();
                    scannerActive = true;
                    document.getElementById('scannerResult').textContent = 'æ¤œå‡ºã—ã¦ã„ã¾ã™...';
                    Quagga.onDetected(onQuaggaDetected);
                });
            }

            function stopScanner() {
                if (!scannerActive) return;
                if (typeof Quagga !== 'undefined') {
                    if (Quagga.stop) {
                        try { Quagga.stop(); } catch (e) { console.warn(e); }
                    }
                    if (Quagga.offDetected) {
                        try { Quagga.offDetected(onQuaggaDetected); } catch (e) { console.warn(e); }
                    } else if (Quagga.off && typeof Quagga.off === 'function') {
                        try { Quagga.off('detected', onQuaggaDetected); } catch (e) { console.warn(e); }
                    }
                }
                scannerActive = false;
            }

            function onQuaggaDetected(result) {
                if (!result || !result.codeResult) return;
                const code = result.codeResult.code;
                if (!code) return;
                // ISBN ã¯æ•°å­—ã®ã¿ã«
                const isbn = code.replace(/[^0-9Xx]/g, '');
                stopScanner();
                document.getElementById('scannerResult').textContent = `æ¤œå‡º: ${isbn} â€” æƒ…å ±å–å¾—ä¸­...`;
                fetchBookByIsbn(isbn);
            }

            function manualIsbn() {
                const input = prompt('ISBN ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆãƒã‚¤ãƒ•ãƒ³å¯ï¼‰:');
                if (!input) return;
                const isbn = input.replace(/[^0-9Xx]/g, '');
                if (!isbn) { alert('ç„¡åŠ¹ãªISBNã§ã™'); return; }
                document.getElementById('scannerResult').textContent = `æ‰‹å‹•: ${isbn} â€” æƒ…å ±å–å¾—ä¸­...`;
                fetchBookByIsbn(isbn);
            }

            function fetchBookByIsbn(isbn) {
                // OpenBD API
                fetch(`https://api.openbd.jp/v1/get?isbn=${encodeURIComponent(isbn)}`)
                    .then(res => res.json())
                    .then(data => {
                        // OpenBD ã¯å­˜åœ¨ã—ãªã„ISBNã®å ´åˆ [null] ã‚’è¿”ã™ã“ã¨ãŒã‚ã‚‹
                        if (!data || !data[0]) {
                            alert('è©²å½“æ›¸ç±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚æ‰‹å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                            return;
                        }
                        const info = data[0].summary || {};
                        const title = info.title || '';
                        const author = info.author || '';
                        const publisher = info.publisher || '';
                        const display = `${title}${author ? ' â€” ' + author : ''}${publisher ? ' â€” ' + publisher : ''}`;
                        const ok = confirm(`ä»¥ä¸‹ã®æ›¸ç±ã‚’ç§‘ç›®ã¨ã—ã¦è¿½åŠ ã—ã¾ã™ã‹ï¼Ÿ\n${display}`);
                        if (ok) {
                            const normalizedTitle = title || isbn;
                            if (!studyData.subjects.includes(normalizedTitle)) {
                                studyData.subjects.push(normalizedTitle);
                                studyData.studyTime[normalizedTitle] = 0;
                                saveData();
                                loadSubjects();
                                alert('ç§‘ç›®ã‚’è¿½åŠ ã—ã¾ã—ãŸ: ' + normalizedTitle);
                            } else {
                                alert('æ—¢ã«åŒã˜ç§‘ç›®ãŒå­˜åœ¨ã—ã¾ã™');
                            }
                            closeScanner();
                        } else {
                            document.getElementById('scannerResult').textContent = 'è¿½åŠ ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸã€‚';
                        }
                    })
                    .catch(err => {
                        console.error(err);
                        alert('æ›¸ç±æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
                    });
            }


function loadBadgeProgress() {
    const badgeProgressContainer = document.getElementById('badgeProgressContainer');
    if (!badgeProgressContainer) return;
    
    badgeProgressContainer.innerHTML = '';
    
    badgeDefinitions.forEach(badge => {
        const isEarned = studyData.badges.includes(badge.id);
        let currentValue = 0;
        let maxValue = badge.requirement;
        let unit = badge.unit || '';
        
        if (badge.type === 'time') {
            if (badge.unit === 'æ™‚é–“') {
                currentValue = Math.floor(studyData.totalTime / 60);
                unit = 'æ™‚é–“';
            } else {
                currentValue = studyData.totalTime;
                unit = 'åˆ†';
            }
        } else if (badge.type === 'tasks') {
            currentValue = studyData.completedTodos;
            unit = 'å€‹';
        } else if (badge.type === 'subjects') {
            currentValue = studyData.subjects.length;
            unit = 'ç§‘ç›®';
        } else {
            currentValue = getSpecialBadgeProgress(badge);
            unit = getSpecialBadgeUnit(badge);
        }
        
        const progress = Math.min((currentValue / maxValue) * 100, 100);
        
        // å¸Œå°‘åº¦ã«å¿œã˜ãŸã‚¯ãƒ©ã‚¹
        const rarityClass = `rarity-${badge.rarity}`;
        
        // é”æˆç‡ã«å¿œã˜ãŸè¡¨ç¤ºã‚¯ãƒ©ã‚¹
        let rateClass = '';
        if (badge.achievementRate < 1) rateClass = 'ultra-rare';
        else if (badge.achievementRate < 5) rateClass = 'super-rare';
        else if (badge.achievementRate < 20) rateClass = 'rare';
        
        const badgeProgressItem = document.createElement('div');
        badgeProgressItem.className = 'badge-progress-item' + (isEarned ? ' earned' : '');
        badgeProgressItem.innerHTML = `
            <div class="badge-progress-header">
                <span class="badge-progress-icon">${badge.icon}</span>
                <div class="badge-progress-info">
                    <div class="badge-progress-name">${badge.name}</div>
                    <div class="badge-progress-desc">${badge.desc}</div>
                </div>
                <div class="badge-rarity ${rarityClass}">${badge.rarity}</div>
            </div>
            <div class="progress-bar">
                <div class="progress-fill ${isEarned ? 'completed' : ''}" style="width: ${progress}%"></div>
            </div>
            <div class="progress-text">
                ${currentValue} / ${maxValue} ${unit}
                ${isEarned ? 'âœ… ç²å¾—æ¸ˆã¿' : `(æ®‹ã‚Š ${Math.max(0, maxValue - currentValue)} ${unit})`}
            </div>
            <div class="badge-progress-stats">
                <div class="global-stats">
                    <span class="achievement-rate ${rateClass}">
                        ğŸ“Š å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼é”æˆç‡: ${badge.achievementRate}%
                    </span>
                </div>
                <div class="rarity-indicator ${rarityClass}">
                    ${getRarityLabel(badge.rarity)}
                </div>
            </div>
        `;
        
        badgeProgressContainer.appendChild(badgeProgressItem);
    });
}

// å¸Œå°‘åº¦ãƒ©ãƒ™ãƒ«å–å¾—
function getRarityLabel(rarity) {
    const labels = {
        'common': 'ã‚ˆãã‚ã‚‹',
        'uncommon': 'ã‚„ã‚„çã—ã„',
        'rare': 'çã—ã„',
        'epic': 'éå¸¸ã«çã—ã„',
        'legendary': 'ä¼èª¬ç´š',
        'mythical': 'ç¥è©±ç´š',
        'transcendent': 'è¶…è¶Šç´š'
    };
    return labels[rarity] || 'unknown';
}

function checkBadges() {
    let newBadges = [];
    
    badgeDefinitions.forEach(badge => {
        let earned = false;
        
        switch(badge.type) {
            case 'time':
                if (badge.unit === 'æ™‚é–“') {
                    earned = Math.floor(studyData.totalTime / 60) >= badge.requirement;
                } else {
                    earned = studyData.totalTime >= badge.requirement;
                }
                break;
            case 'tasks':
                earned = studyData.completedTodos >= badge.requirement;
                break;
            case 'subjects':
                earned = studyData.subjects.length >= badge.requirement;
                break;
            case 'streak':
                earned = getCurrentStreak() >= badge.requirement;
                break;
            // ãã®ä»–ã®ç‰¹æ®Šãƒãƒƒã‚¸ã®å‡¦ç†...
            default:
                earned = checkSpecialBadge(badge);
                break;
        }
        
        if (earned && !studyData.badges.includes(badge.id)) {
            studyData.badges.push(badge.id);
            newBadges.push(badge);
        }
    });
    
    // æ–°ã—ã„ãƒãƒƒã‚¸ã®é€šçŸ¥
    newBadges.forEach((badge, index) => {
        setTimeout(() => {
            showBadgeNotification(badge);
        }, 500 * (index + 1));
    });
    
    if (newBadges.length > 0) {
        loadBadgeProgress();
        loadFriendRanking();
    }
}

// ç‰¹æ®Šãƒãƒƒã‚¸ã®é€²æ—è¨ˆç®—
function getSpecialBadgeProgress(badge) {
    switch(badge.type) {
        case 'streak': return getCurrentStreak();
        case 'early_study': return getEarlyStudyCount();
        case 'night_study': return getNightStudyCount();
        case 'weekend_study': return getWeekendStudyCount();
        case 'long_session_3h': return getLongSessionCount(180);
        case 'long_session_5h': return getLongSessionCount(300);
        case 'long_session_8h': return getLongSessionCount(480);
        case 'marathon_session': return getLongSessionCount(600);
        case 'ultra_marathon': return getLongSessionCount(720);
        case 'iron_will': return getLongSessionCount(900);
        default: return 0;
    }
}

// ç‰¹æ®Šãƒãƒƒã‚¸ã®å˜ä½å–å¾—
function getSpecialBadgeUnit(badge) {
    switch(badge.type) {
        case 'streak': return 'æ—¥';
        case 'early_study':
        case 'night_study':
        case 'weekend_study':
        case 'long_session_3h':
        case 'long_session_5h':
        case 'long_session_8h':
        case 'marathon_session':
        case 'ultra_marathon':
        case 'iron_will': return 'å›';
        default: return '';
    }
}

// ç‰¹æ®Šãƒãƒƒã‚¸ã®ãƒã‚§ãƒƒã‚¯
function checkSpecialBadge(badge) {
    switch(badge.type) {
        case 'daily_time':
            return getMaxDailyTime() >= badge.requirement;
        case 'daily_tasks':
            return getMaxDailyTasks() >= badge.requirement;
        case 'yearly_time':
            return Math.floor(studyData.totalTime / 60) >= badge.requirement;
        case 'lifetime':
            return Math.floor(studyData.totalTime / 60) >= badge.requirement;
        case 'singularity':
            return studyData.badges.length >= badgeDefinitions.length - 1;
        default:
            return false;
    }
}

function loadBadges() {
    const badgeContainer = document.getElementById('badgeContainer');
    if (!badgeContainer) return;
    
    badgeContainer.innerHTML = '';
    
    // ç²å¾—æ¸ˆã¿ãƒãƒƒã‚¸ã¨æœªç²å¾—ãƒãƒƒã‚¸ã‚’åˆ†ã‘ã¦è¡¨ç¤º
    const earnedBadges = badgeDefinitions.filter(badge => studyData.badges.includes(badge.id));
    const unearnedBadges = badgeDefinitions.filter(badge => !studyData.badges.includes(badge.id));
    
    // ç²å¾—æ¸ˆã¿ãƒãƒƒã‚¸ã‚’å¸Œå°‘åº¦é †ã§ã‚½ãƒ¼ãƒˆ
    earnedBadges.sort((a, b) => a.achievementRate - b.achievementRate);
    
    [...earnedBadges, ...unearnedBadges].forEach(badge => {
        const isEarned = studyData.badges.includes(badge.id);
        const rarityClass = `rarity-${badge.rarity}`;
        
        let rateClass = '';
        if (badge.achievementRate < 1) rateClass = 'ultra-rare';
        else if (badge.achievementRate < 5) rateClass = 'super-rare';
        else if (badge.achievementRate < 20) rateClass = 'rare';
        
        const badgeElement = document.createElement('div');
        badgeElement.className = 'badge' + (isEarned ? ' earned' : '');
        badgeElement.style.position = 'relative';
        
        badgeElement.innerHTML = `
            <span class="badge-icon">${badge.icon}</span>
            <div class="badge-name">${badge.name}</div>
            <div class="achievement-rate ${rateClass}">
                ${badge.achievementRate}%
            </div>
            ${isEarned ? `<div class="badge-rarity ${rarityClass}">${badge.rarity}</div>` : ''}
        `;
        
        // ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—åŠ¹æœ
        badgeElement.title = `${badge.desc}\né”æˆç‡: ${badge.achievementRate}% (${getRarityLabel(badge.rarity)})`;
        
        badgeContainer.appendChild(badgeElement);
    });
    
    // çµ±è¨ˆæƒ…å ±ã‚’è¿½åŠ 
    addBadgeStatistics(earnedBadges);
}

// ãƒãƒƒã‚¸çµ±è¨ˆæƒ…å ±ã‚’è¿½åŠ 
function addBadgeStatistics(earnedBadges) {
    const badgeContainer = document.getElementById('badgeContainer');
    
    const totalBadges = badgeDefinitions.length;
    const earnedCount = earnedBadges.length;
    const completionRate = ((earnedCount / totalBadges) * 100).toFixed(1);
    
    // å¸Œå°‘åº¦åˆ¥çµ±è¨ˆ
    const rarityStats = {};
    earnedBadges.forEach(badge => {
        rarityStats[badge.rarity] = (rarityStats[badge.rarity] || 0) + 1;
    });
    
    // æœ€ã‚‚å¸Œå°‘ãªãƒãƒƒã‚¸
    const rarestBadge = earnedBadges.reduce((rarest, badge) => 
        badge.achievementRate < (rarest?.achievementRate || Infinity) ? badge : rarest, null);
    
    const statsElement = document.createElement('div');
    statsElement.className = 'badge-statistics';
    statsElement.style.cssText = `
        grid-column: 1 / -1;
        background: linear-gradient(135deg, #f8f9fa, #e9ecef);
        padding: 20px;
        border-radius: 12px;
        border: 2px solid #0d6efd;
        margin-top: 20px;
        text-align: center;
    `;
    
    statsElement.innerHTML = `
        <h4 style="color: #0d6efd; margin-bottom: 15px;">ğŸ“Š ã‚ãªãŸã®ãƒãƒƒã‚¸çµ±è¨ˆ</h4>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
            <div style="background: white; padding: 15px; border-radius: 8px;">
                <div style="font-size: 1.5rem; font-weight: bold; color: #0d6efd;">${earnedCount}/${totalBadges}</div>
                <div style="color: #6c757d;">ç²å¾—ç‡: ${completionRate}%</div>
            </div>
            ${rarestBadge ? `
            <div style="background: white; padding: 15px; border-radius: 8px;">
                <div style="font-size: 1.2rem;">${rarestBadge.icon} ${rarestBadge.name}</div>
                <div style="color: #dc3545; font-weight: bold;">æœ€å¸Œå°‘ãƒãƒƒã‚¸ (${rarestBadge.achievementRate}%)</div>
            </div>
            ` : ''}
            <div style="background: white; padding: 15px; border-radius: 8px;">
                <div style="font-size: 1rem; font-weight: bold; color: #28a745;">
                    ä¸Šä½ ${calculateUserRank(earnedBadges)}%
                </div>
                <div style="color: #6c757d;">å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸­ã®é †ä½</div>
            </div>
        </div>
        <div style="margin-top: 15px; font-size: 0.9rem; color: #6c757d;">
            ğŸ’¡ é”æˆç‡1%æœªæº€ã®ãƒãƒƒã‚¸ã¯è¶…ãƒ¬ã‚¢ï¼ã‚ãªãŸã¯é¸ã°ã‚Œã—å­¦ç¿’è€…ã§ã™ï¼
        </div>
    `;
    
    badgeContainer.appendChild(statsElement);
}

// ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ©ãƒ³ã‚¯è¨ˆç®—ï¼ˆç°¡æ˜“ç‰ˆï¼‰
function calculateUserRank(earnedBadges) {
    const totalScore = earnedBadges.reduce((score, badge) => {
        const rarityMultiplier = {
            'common': 1, 'uncommon': 2, 'rare': 5, 'epic': 10,
            'legendary': 25, 'mythical': 50, 'transcendent': 100
        };
        return score + (100 - badge.achievementRate) * (rarityMultiplier[badge.rarity] || 1);
    }, 0);
    
    // ã‚¹ã‚³ã‚¢ã«åŸºã¥ã„ã¦ä¸Šä½ãƒ‘ãƒ¼ã‚»ãƒ³ãƒ†ãƒ¼ã‚¸ã‚’è¨ˆç®—
    if (totalScore > 10000) return 0.1;
    if (totalScore > 5000) return 0.5;
    if (totalScore > 2000) return 1;
    if (totalScore > 1000) return 5;
    if (totalScore > 500) return 10;
    if (totalScore > 200) return 25;
    return 50;
}

// çµ±è¨ˆæ›´æ–°
function updateStats() {
    document.getElementById('totalTime').textContent = studyData.totalTime;
    document.getElementById('completedTodos').textContent = studyData.completedTodos;
    document.getElementById('totalSubjects').textContent = studyData.subjects.length;
    document.getElementById('weeklyTime').textContent = Math.floor(studyData.totalTime * 0.7);
}

// ãƒãƒ£ãƒ¼ãƒˆä½œæˆ
function createChart() {
    const ctx = document.getElementById('studyChart');
    if (!ctx) return;
    
    if (currentChart) {
        currentChart.destroy();
    }
    
    const subjects = Object.keys(studyData.studyTime);
    const times = Object.values(studyData.studyTime);
    
    if (subjects.length === 0) {
        ctx.getContext('2d').clearRect(0, 0, ctx.width, ctx.height);
        return;
    }
    
    currentChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: subjects,
            datasets: [{
                data: times,
                backgroundColor: [
                    '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', 
                    '#9966FF', '#FF9F40', '#FF6384', '#C9CBCF'
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
}

// ãƒãƒƒã‚¸é€šçŸ¥è¡¨ç¤º
function showBadgeNotification(badge) {
    const rarityText = getRarityLabel(badge.rarity);
    const message = `ğŸ‰ æ–°ã—ã„ãƒãƒƒã‚¸ã‚’ç²å¾—ã—ã¾ã—ãŸï¼\n\n${badge.icon} ${badge.name}\n${badge.desc}\n\nå¸Œå°‘åº¦: ${rarityText}\né”æˆç‡: ${badge.achievementRate}%\n\nãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼ ğŸ†âœ¨`;
    alert(message);
}

// ç¾åœ¨ã®é€£ç¶šå‹‰å¼·æ—¥æ•°ã‚’å–å¾—ï¼ˆç°¡æ˜“ç‰ˆï¼‰
function getCurrentStreak() {
    return Math.floor(studyData.totalTime / 60); // ç°¡æ˜“è¨ˆç®—
}

// æ—©æœå‹‰å¼·å›æ•°ã‚’å–å¾—ï¼ˆç°¡æ˜“ç‰ˆï¼‰
function getEarlyStudyCount() {
    return Math.floor(studyData.totalTime / 120); // ç°¡æ˜“è¨ˆç®—
}

// å¤œé–“å‹‰å¼·å›æ•°ã‚’å–å¾—ï¼ˆç°¡æ˜“ç‰ˆï¼‰
function getNightStudyCount() {
    return Math.floor(studyData.totalTime / 100); // ç°¡æ˜“è¨ˆç®—
}

// é€±æœ«å‹‰å¼·å›æ•°ã‚’å–å¾—ï¼ˆç°¡æ˜“ç‰ˆï¼‰
function getWeekendStudyCount() {
    return Math.floor(studyData.totalTime / 150); // ç°¡æ˜“è¨ˆç®—
}

// é•·æ™‚é–“ã‚»ãƒƒã‚·ãƒ§ãƒ³å›æ•°ã‚’å–å¾—ï¼ˆç°¡æ˜“ç‰ˆï¼‰
function getLongSessionCount(minutes) {
    return Math.floor(studyData.totalTime / (minutes * 2)); // ç°¡æ˜“è¨ˆç®—
}

// æœ€å¤§æ—¥é–“å‹‰å¼·æ™‚é–“ã‚’å–å¾—ï¼ˆç°¡æ˜“ç‰ˆï¼‰
function getMaxDailyTime() {
    return Math.floor(studyData.totalTime / 10); // ç°¡æ˜“è¨ˆç®—
}

// æœ€å¤§æ—¥é–“ã‚¿ã‚¹ã‚¯æ•°ã‚’å–å¾—ï¼ˆç°¡æ˜“ç‰ˆï¼‰
function getMaxDailyTasks() {
    return Math.floor(studyData.completedTodos / 5); // ç°¡æ˜“è¨ˆç®—
}

// ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³æ©Ÿèƒ½
function loadTimeline() {
    const timelineContainer = document.getElementById('timelineContainer');
    if (!timelineContainer) return;
    
    timelineContainer.innerHTML = '';
    
    if (studyData.timeline.length === 0) {
        timelineContainer.innerHTML = `
            <div class="no-posts">
                <div class="no-posts-icon">ğŸ“±</div>
                <p>ã¾ã æŠ•ç¨¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚<br>æœ€åˆã®æŠ•ç¨¿ã‚’ã—ã¦ã¿ã¾ã—ã‚‡ã†ï¼</p>
            </div>
        `;
        return;
    }
    
    studyData.timeline.forEach(post => {
        const postElement = createTimelinePost(post);
        timelineContainer.appendChild(postElement);
    });
}

function createPost() {
    const content = document.getElementById('postContent').value.trim();
    const type = document.getElementById('postType').value;
    
    if (!content) {
        alert('æŠ•ç¨¿å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
        return;
    }
    
    const post = {
        id: Date.now(),
        author: 'ã‚ãªãŸ',
        avatar: 'ğŸ‘¤',
        content: content,
        type: type,
        timestamp: new Date().toISOString(),
        likes: 0,
        comments: [],
        isOwn: true
    };
    
    studyData.timeline.unshift(post);
    document.getElementById('postContent').value = '';
    saveData();
    loadTimeline();
}

function createAutoPost(type, data) {
    let content = '';
    let postType = 'study';
    
    switch(type) {
        case 'study_complete':
            content = `ğŸ“š ${data.subject}ã‚’${data.minutes}åˆ†é–“å‹‰å¼·ã—ã¾ã—ãŸï¼é›†ä¸­ã§ãã¦è‰¯ã‹ã£ãŸï¼ ğŸ’ª`;
            postType = 'study';
            break;
        case 'task_complete':
            content = `âœ… ã€Œ${data.title}ã€ã‚’å®Œäº†ã—ã¾ã—ãŸï¼ä¸€ã¤ãšã¤ç€å®Ÿã«é€²æ­©ä¸­ï¼ ğŸ¯`;
            postType = 'achievement';
            break;
        case 'badge_earned':
            content = `ğŸ† æ–°ã—ã„ãƒãƒƒã‚¸ã€Œ${data.name}ã€ã‚’ç²å¾—ã—ã¾ã—ãŸï¼${data.desc} âœ¨`;
            postType = 'achievement';
            break;
    }
    
    if (content) {
        const post = {
            id: Date.now(),
            author: 'ã‚ãªãŸ',
            avatar: 'ğŸ‘¤',
            content: content,
            type: postType,
            timestamp: new Date().toISOString(),
            likes: 0,
            comments: [],
            isOwn: true
        };
        
        studyData.timeline.unshift(post);
        saveData();
    }
}

function createTimelinePost(post) {
    const postElement = document.createElement('div');
    postElement.className = 'timeline-post' + (post.isOwn ? ' own' : '');
    
    const timeAgo = getTimeAgo(new Date(post.timestamp));
    
    postElement.innerHTML = `
        <div class="post-header">
            <div class="post-avatar">${post.avatar}</div>
            <div class="post-info">
                <div class="post-author">${post.author}</div>
                <div class="post-time">${timeAgo}</div>
            </div>
            <span class="post-type ${post.type}">${getPostTypeLabel(post.type)}</span>
        </div>
        <div class="post-content">${post.content}</div>
        <div class="post-actions">
            <button class="post-action-btn ${post.liked ? 'liked' : ''}" onclick="toggleLike(${post.id})">
                â¤ï¸ ${post.likes}
            </button>
            <button class="post-action-btn" onclick="toggleComments(${post.id})">
                ğŸ’¬ ${post.comments.length}
            </button>
        </div>
        <div class="comments-section" id="comments-${post.id}">
            <div class="comment-form">
                <input type="text" class="comment-input" placeholder="ã‚³ãƒ¡ãƒ³ãƒˆã‚’å…¥åŠ›..." id="comment-input-${post.id}">
                <button class="comment-btn" onclick="addComment(${post.id})">æŠ•ç¨¿</button>
            </div>
            <div id="comment-list-${post.id}">
                ${post.comments.map(comment => createCommentHTML(comment)).join('')}
            </div>
        </div>
    `;
    
    return postElement;
}

function getPostTypeLabel(type) {
    const labels = {
        'study': 'ğŸ“š å‹‰å¼·',
        'achievement': 'ğŸ† é”æˆ',
        'motivation': 'ğŸ’ª å¿œæ´',
        'question': 'â“ è³ªå•'
    };
    return labels[type] || 'ğŸ“ æŠ•ç¨¿';
}

function getTimeAgo(date) {
    const now = new Date();
    const diff = now - date;
    const minutes = Math.floor(diff / 60000);
    const hours = Math.floor(minutes / 60);
    const days = Math.floor(hours / 24);
    
    if (days > 0) return `${days}æ—¥å‰`;
    if (hours > 0) return `${hours}æ™‚é–“å‰`;
    if (minutes > 0) return `${minutes}åˆ†å‰`;
    return 'ãŸã£ãŸä»Š';
}

function toggleLike(postId) {
    const post = studyData.timeline.find(p => p.id === postId);
    if (post) {
        if (post.liked) {
            post.likes--;
            post.liked = false;
        } else {
            post.likes++;
            post.liked = true;
        }
        saveData();
        loadTimeline();
    }
}

function toggleComments(postId) {
    const commentsSection = document.getElementById(`comments-${postId}`);
    if (commentsSection) {
        commentsSection.classList.toggle('show');
    }
}

function addComment(postId) {
    const input = document.getElementById(`comment-input-${postId}`);
    const content = input.value.trim();
    
    if (!content) return;
    
    const post = studyData.timeline.find(p => p.id === postId);
    if (post) {
        const comment = {
            id: Date.now(),
            author: 'ã‚ãªãŸ',
            avatar: 'ğŸ‘¤',
            content: content,
            timestamp: new Date().toISOString()
        };
        
        post.comments.push(comment);
        input.value = '';
        saveData();
        loadTimeline();
    }
}

function createCommentHTML(comment) {
    const timeAgo = getTimeAgo(new Date(comment.timestamp));
    return `
        <div class="comment">
            <div class="comment-avatar">${comment.avatar}</div>
            <div class="comment-content">
                <div class="comment-author">${comment.author}</div>
                <div class="comment-text">${comment.content}</div>
                <div class="comment-time">${timeAgo}</div>
            </div>
        </div>
    `;
}

// ç§‘ç›®è¿½åŠ æ–¹æ³•åˆ‡ã‚Šæ›¿ãˆ
function showAddMethod(method) {
    document.querySelectorAll('.method-tab-btn').forEach(btn => btn.classList.remove('active'));
    document.querySelectorAll('.add-method-content').forEach(content => content.classList.remove('active'));
    const btn = document.querySelector(`.method-tab-btn[onclick="showAddMethod('${method}')"]`);
    if (btn) btn.classList.add('active');
    document.getElementById(`${method}-add`).classList.add('active');
}
    </script>
</body>
</html>
